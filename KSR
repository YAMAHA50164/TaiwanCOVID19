<%@ Page Language="VB" AutoEventWireup="false" CodeFile="KSR_Highchart_2.aspx.vb"
    Inherits="Owen_highchart" %>

<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>L8B KSR</title>
    <script src="../../Script/jquery-3.4.1.js" type="text/javascript"></script>
    <!-- <script src="../../Highcharts-Stock-9.2.2/code/highstock.js" type="text/javascript"></script> -->    
    <script src="../../Highcharts-10.0.0/code/highcharts.js" type="text/javascript"></script>
    <script src="../../Highcharts-10.0.0/code/modules/exporting.js" type="text/javascript"></script>
    <script src="../../Highcharts-10.0.0/code/modules/export-data.js" type="text/javascript"></script>
    <!-- <script src="../Highcharts-9.2.2/code/modules/data.js" type="text/javascript"></script> -->
    <script src="../../Highcharts-10.0.0/code/modules/accessibility.js" type="text/javascript"></script>
    <script src="../../Highcharts-10.0.0/code/modules/drilldown.js" type="text/javascript"></script>
    <script src="../../Common_System/Calendar/Script/jQuery/jquery.qtip-1.0.0-rc3.min.js" type="text/javascript"></script>

    <script src="../../../DataTables/datatables.js" type="text/javascript"></script>
    <link href="../../../DataTables/datatables.css" rel="stylesheet" type="text/css" />
    <script src="../../DataTables/select/1.3.4/dataTables.select.min.js" type="text/javascript"></script>
    <link href="../../DataTables/select/1.3.4/select.dataTables.min.css" rel="stylesheet" type="text/css" />

    <script src="../../bootstrap-4.4.1-dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <!-- <script src="../../bootstrap-4.4.1-dist/js/bootstrap.bundle.min.js" type="text/javascript"></script> -->
    <link href="../../bootstrap-4.4.1-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" />    
    

    <!-- <script type="text/javascript">
        function mouseOnBand(e) {
            if (e.type == 'mouseover') {
                this.svgElem.attr({
                    'stroke-width': 2,
                    zIndex: 10,
                    stroke: 'black',
                    fill: Highcharts.Color(this.options.color).setOpacity(1.0).get()
                });
                //console.log(chart);
            } else {
                this.svgElem.attr({
                    'stroke-width': 1,
                    zIndex: 0,
                    stroke: 'transparent',
                    fill: this.options.color
                });
            }
        }
    </script> -->
    <script type="text/javascript" charset="UTF-8">

        $(document).ready(function () {

            var browser = detectBrowser();

            if (browser == undefined | browser == 'IE'){
                alert('使用chrome開啟才能有完整效果');
            }

            
            if (location.href.toLowerCase().indexOf('corpnet') < 0){
                window.location.href = location.href.replace('tw100018633/','tw100018633.corpnet.auo.com/');
            }

            init();            

            $("#button-demo").click(function () {
                // add_toast();
                OPI(Date.now());
            });


            // $("#checkbox").bootstrapSwitch({  
            //     onText : "ON",      // 設定ON文字  
            //     offText : "OFF",    // 設定OFF文字  
            //     onColor : "success",// 設定ON文字顏色     (info/success/warning/danger/primary)  
            //     offColor : "info",  // 設定OFF文字顏色        (info/success/warning/danger/primary)  
            //     size : "normal",    // 設定控制元件大小,從小到大  (mini/small/normal/large)  
            //     // 當開關狀態改變時觸發  
            //     onSwitchChange : function(event, state) {  
            //     if (state == true) {  
            //         //alert("ON");  
            //     } else {  
            //         //alert("OFF");  
            //     }  
            //     }  
            // });  
           
        });

        function init(){
            $('#Hidden_LOT').val('');
            $('#Hidden_CST').val('');
            // $('#Hidden_SLOW').val('');

            $('#BT_AUHold').attr('title', '');
            $('#BT_AUHold').attr('disabled', true);
            $('#BT_AUHold').attr('class', 'btn btn-dark');

            $('#BT_AUQuitSampling').attr('title', '');
            $('#BT_AUQuitSampling').attr('disabled', true);
            $('#BT_AUQuitSampling').attr('class', 'btn btn-dark');

            $('#BT_BUDispatchListInfo').attr('title', '');
            $('#BT_BUDispatchListInfo').attr('disabled', true);
            $('#BT_BUDispatchListInfo').attr('class', 'btn btn-dark');

            $('#BT_AUChangeLotPriority').attr('title', '');
            $('#BT_AUChangeLotPriority').attr('disabled', true);
            $('#BT_AUChangeLotPriority').attr('class', 'btn btn-dark');

            // $('#BT_AURelease').attr('title', '');
            $('#BT_AURelease').attr('disabled', true);
            $('#BT_AURelease').attr('class', 'btn btn-dark');

        }

        function display_popup(FUNC, POP_MSG) {
            if (!POP_MSG) {
                document.getElementById("POP_MSG").style.display = "none";
            } else {
                if (!FUNC) FUNC = window.event;
                if (!FUNC) return;
                var x = FUNC.clientX;
                var y = FUNC.clientY;
                y = document.documentElement.scrollTop + event.clientY;
                x = document.documentElement.scrollLeft + event.clientX;

                var x_shift = 200;                
                if (x > 1000){
                    x_shift = 400;
                }

                document.getElementById("POP_MSG").innerHTML = POP_MSG;
                document.getElementById("POP_MSG").style.left = (x - x_shift) + "px";                
                document.getElementById("POP_MSG").style.top = (y + 5) + "px";
                document.getElementById("POP_MSG").style.display = "block";
            }
        }

        function add_toast() {
            var d = new Date();

            // Initialize container
            var container = document.getElementById("Div1");


            var div_1 = document.createElement("div");
            div_1.id = "DIV_TOAST_" + Date.now();
            div_1.setAttribute("class", "toast");
            div_1.setAttribute("data-autohide", false);

            var div_header = document.createElement("div");
            div_header.setAttribute("class", "toast-header");

            var label_title_1 = document.createElement("label");
            label_title_1.setAttribute("class", "mr-auto text-primary");
            label_title_1.innerText = "Toast 標題"

            var label_title_2 = document.createElement("label");
            label_title_2.setAttribute("class", "text-muted");
            label_title_2.innerText = d.getFullYear() + "-" + d.getMonth() + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();

            var label_bt = document.createElement("button");
            label_bt.type = "button";
            label_bt.setAttribute("class", "ml-2 mb-1 close");
            label_bt.setAttribute("data-dismiss", "toast");
            label_bt.innerText = "×"

            // label_bt.data-dismiss="toast";



            var div_body = document.createElement("div");
            div_body.innerText = "Div_Body";
            div_body.setAttribute("class", "toast-body");


            // Add to container
            div_header.appendChild(label_title_1);
            div_header.appendChild(label_title_2);
            div_header.appendChild(label_bt);

            div_1.appendChild(div_header);
            div_1.appendChild(div_body);
            container.appendChild(div_1);


            // $('.toast').toast('show');
            $('#' + div_1.id).toast('show')


        }

        function OPI(lot_id) {
            var d = new Date();

            // Initialize container
            var container = document.getElementById("Div1");


            var div_1 = document.createElement("div");
            div_1.id = "DIV_TOAST_" + Date.now();
            div_1.setAttribute("class", "toast");
            div_1.setAttribute("data-autohide", false);

            var div_header = document.createElement("div");
            div_header.setAttribute("class", "toast-header");

            var label_title_1 = document.createElement("label");
            label_title_1.setAttribute("class", "mr-auto text-primary");
            label_title_1.innerText = lot_id + " 標題"

            var label_title_2 = document.createElement("label");
            label_title_2.setAttribute("class", "text-muted");
            label_title_2.innerText = d.getFullYear() + "-" + d.getMonth() + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();

            var label_bt = document.createElement("button");
            label_bt.type = "button";
            label_bt.setAttribute("class", "ml-2 mb-1 close");
            label_bt.setAttribute("data-dismiss", "toast");
            label_bt.innerText = "×"

            // label_bt.data-dismiss="toast";



            var div_body = document.createElement("div");
            div_body.innerText = "Div_Body";
            div_body.setAttribute("class", "toast-body");


            // Add to container
            div_header.appendChild(label_title_1);
            div_header.appendChild(label_title_2);
            div_header.appendChild(label_bt);

            div_1.appendChild(div_header);
            div_1.appendChild(div_body);
            container.appendChild(div_1);


            // $('.toast').toast('show');
            $('#' + div_1.id).toast('show')


        }

        

        function MES(trx_name){

            $('#exampleModalLabel')[0].innerText = trx_name;


            $('.DIV_MES').attr('style', 'display:none;');
            $('.MES_POST').val('');

            if (trx_name == 'AUQuitSampling'){
                $('#DIV_AUQuitSampling').attr('style', 'display:block;');

            }else if (trx_name == 'BUDispatchListInfo'){
                $('#DIV_BUDispatchListInfo').attr('style', 'display:block;');

                var EQP_BUDispatchListInfo = document.getElementById("EQP_BUDispatchListInfo");
                if (EQP_BUDispatchListInfo.length == 0){
                    $.ajax({ 
                        type: 'post',  
                        data: 
                        {
                            SQL: "SELECT DISTINCT eqp_id " + 
                                "FROM aryods.c_eqp_eqpt_mst " + 
                                "WHERE eqp_area <> 'DUMMY' " + 
                                "	AND eqp_id LIKE 'AK%00' " +                            
                                "ORDER BY eqp_id "
                                // "	AND (eqp_id LIKE 'AK%00' OR eqp_id LIKE 'IKASA%')  " + 
                        },
                        
                        url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=SQL&time=' + Date.now(), 
                        dataType: 'json', 
                        success:function(data){
                            if(data){
                                                  
                                var option_null = document.createElement("option");
                                option_null.text = "";
                                EQP_BUDispatchListInfo.add(option_null);
                                
                                $.each(data, function(num, data) {
                                    var option_eqp = document.createElement("option");
                                    option_eqp.text = data["EQP_ID"];
                                    EQP_BUDispatchListInfo.add(option_eqp);
                                });
                                
                            }
                        }
                    }); 
                }

            }else if (trx_name == 'AUChangeLotPriority'){
                $('#DIV_AUChangeLotPriority').attr('style', 'display:block;');

            }else if (trx_name == 'AUHold'){                
                $('#DIV_AUHold').attr('style', 'display:block;');
                var REASONCODE_AUHold = document.getElementById("REASONCODE_AUHold");
                if (REASONCODE_AUHold.length == 0){
                    $.ajax({ 
                        type: 'post',  
                        data: 
                        {
                            SQL: "SELECT * FROM aryods.c_lot_hold_code_mst WHERE hold_cat = 'HOLD' ORDER BY hold_code_id"
                        },
                        url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=SQL&time=' + Date.now(), 
                        dataType: 'json', 
                        success:function(data){
                            if(data){
                                
                                var option_null = document.createElement("option");
                                option_null.text = "";
                                REASONCODE_AUHold.add(option_null);

                                $.each(data, function(num, data) {
                                    var option_hold = document.createElement("option");
                                    option_hold.text = data["HOLD_CODE_ID"] + '_' + data["HOLD_CODE_DESC"];
                                    REASONCODE_AUHold.add(option_hold);
                                });
                                
                            }
                        }
                    }); 
                }
                
                var DEPARTMENT_AUHold = document.getElementById("DEPARTMENT_AUHold");
                if (DEPARTMENT_AUHold.length == 0){
                    $.ajax({ 
                        type: 'post', 
                        data: 
                        {
                            SQL: "SELECT department, department_name,  " + 
                                "	CASE SUBSTR(department, 5, 1)  " +
                                    "		WHEN 'T' THEN 'ARRAY' " +
                                    "		WHEN 'P' THEN 'ARRAY' " +
                                    "		WHEN 'E' THEN 'ARRAY' " +
                                    "		WHEN 'I' THEN 'ARRAY' " +
                                    "		WHEN 'M' THEN 'ARRAY' " +
                                    "		WHEN 'B' THEN 'CF' " +
                                    "		WHEN 'C' THEN 'CF' " +
                                    "		WHEN 'K' THEN 'CF' " +
                                    "		WHEN 'H' THEN 'CELL' " +
                                    "		WHEN 'L' THEN 'CELL' " +
                                    "		WHEN 'N' THEN 'CELL' " +
                                    "		WHEN 'A' THEN 'OTHER' " +
                                    "		WHEN 'D' THEN 'OTHER' " +
                                    "		WHEN 'V' THEN 'OTHER' " +
                                    "	END AS area, " +
                                    "	COUNT(CASE WHEN user_desc = 'DL' THEN user_id END) AS DL_CNT, " +
                                    "	COUNT(CASE WHEN user_desc = 'IDL' THEN user_id END) AS IDL_CNT " +
                                    "FROM aryods.c_fac_user_mst " +
                                    "WHERE change_status = 'Y' " +
                                    "	AND site_id = 'L8B' " +
                                    "	AND department LIKE 'ML8B%' " +
                                    "	AND department NOT IN ( 'ML8B00', 'ML8B0A', 'ML8B0B', 'ML8B0C' ) " +
                                    "GROUP BY department, department_name, " +
                                    "	CASE SUBSTR(department, 5, 1)  " +
                                    "		WHEN 'T' THEN 'ARRAY' " +
                                    "		WHEN 'P' THEN 'ARRAY' " +
                                    "		WHEN 'E' THEN 'ARRAY' " +
                                    "		WHEN 'I' THEN 'ARRAY' " +
                                    "		WHEN 'M' THEN 'ARRAY' " +
                                    "		WHEN 'B' THEN 'CF' " +
                                    "		WHEN 'C' THEN 'CF' " +
                                    "		WHEN 'K' THEN 'CF' " +
                                    "		WHEN 'H' THEN 'CELL' " +
                                    "		WHEN 'L' THEN 'CELL' " +
                                    "		WHEN 'N' THEN 'CELL' " +
                                    "		WHEN 'A' THEN 'OTHER' " +
                                    "		WHEN 'D' THEN 'OTHER' " +
                                    "		WHEN 'V' THEN 'OTHER' " +
                                    "	END " +
                                    "ORDER BY CASE SUBSTR(department, 5, 1)  " +
                                    "		WHEN 'T' THEN 'ARRAY' " +
                                    "		WHEN 'P' THEN 'ARRAY' " +
                                    "		WHEN 'E' THEN 'ARRAY' " +
                                    "		WHEN 'I' THEN 'ARRAY' " +
                                    "		WHEN 'M' THEN 'ARRAY' " +
                                    "		WHEN 'B' THEN 'CF' " +
                                    "		WHEN 'C' THEN 'CF' " +
                                    "		WHEN 'K' THEN 'CF' " +
                                    "		WHEN 'H' THEN 'CELL' " +
                                    "		WHEN 'L' THEN 'CELL' " +
                                    "		WHEN 'N' THEN 'CELL' " +
                                    "		WHEN 'A' THEN 'OTHER' " +
                                    "		WHEN 'D' THEN 'OTHER' " +
                                    "		WHEN 'V' THEN 'OTHER' " +
                                    "	END, " + 
                                    "	department "
                        },
                        url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=SQL&time=' + Date.now(), 
                        dataType: 'json', 
                        success:function(data){
                            if(data){
                                
                                var temp_area = '';
                                
                                var option_null = document.createElement("option");
                                option_null.text = "";
                                DEPARTMENT_AUHold.add(option_null);

                                $.each(data, function(num, data) {
                                    var option_dept = document.createElement("option");
                                    option_dept.text = data["DEPARTMENT"];

                                    if (temp_area == ''){
                                        temp_area = data["AREA"];

                                        var option_area = document.createElement("option");
                                        option_area.text = data["AREA"];
                                        option_area.disabled = true;
                                        option_area.style.color = "darkorange";
                                        DEPARTMENT_AUHold.add(option_area);

                                    }else if (temp_area != data["AREA"]){
                                        temp_area = data["AREA"];

                                        var option_area = document.createElement("option");
                                        option_area.text = data["AREA"];
                                        option_area.disabled = true;
                                        option_area.style.color = "darkorange";
                                        DEPARTMENT_AUHold.add(option_area);
                                    }
                                    
                                    DEPARTMENT_AUHold.add(option_dept);
                                });
                                
                            }
                        }
                    }); 

                }

            }else if (trx_name == 'AURelease'){
                // document.getElementById('DIV_AURelease').style.display = 'block';
                $('#DIV_AURelease').attr('style', 'display:block;');
            }


            // var lot_list = [];                        
            // for( let i = 0 ; i < $('#Hidden_LOT').val().split(',').length ; i++ ){
            //     lot_list.push($('#Hidden_LOT').val().split(',')[i] + '**');
            // }
            // var cst_list = [];
            // for( let i = 0 ; i < $('#Hidden_CST').val().split(',').length ; i++ ){
            //     cst_list.push($('#Hidden_CST').val().split(',')[i] + '**');
            // }


            //  2022-05-04
            //  把LOT、CST真的送出去測試
            // if ($('#Hidden_LOT').val() != ''){
            //     $('#Hidden_LOT').val($('#Hidden_LOT').val().replaceAll(',', '__,') + ",__");
            //     $('#Hidden_CST').val($('#Hidden_CST').val().replaceAll(',', '__,') + ",__");
            // }
                        
            
            if ($('#Hidden_LOT').val() == ""){
                $('#BT_LigerTangoMES').attr('disabled', true);
                $('#BT_LigerTangoMES')[0].innerText = '請勾選LOT';
                $('#BT_LigerTangoMES').attr('class', 'btn btn-dark');

            }else{
                $('#BT_LigerTangoMES').attr('disabled', false);
                $('#BT_LigerTangoMES')[0].innerText = 'UAC驗證';
                $('#BT_LigerTangoMES').attr('class', 'btn btn-primary');
                


                var test_cnt = 0
                var test_post_cnt = 0
                
                $('#LOT_List')[0].innerHTML = $('#Hidden_LOT').val();
                // $('#BT_LigerTangoMES').on("click", function(){ 

                //     // 有點過幾次就都會再送出一次？
                //     test_cnt += 1;
                //     if ($('#exampleModalLabel')[0].innerText == trx_name){
                //         test_post_cnt += 1;
                //         // 該填該選的都要有值
                //         var json_note = $('.MES_POST[id^="NOTE_' + trx_name + '"]').val();
                //         var json_reasoncode = $('[id^="REASONCODE_' + trx_name + '"] option:selected').val();
                //         var json_department = $('[id^="DEPARTMENT_' + trx_name + '"] option:selected').val();
                //         var json_eqp = $('[id^="EQP_' + trx_name + '"] option:selected').val();
                //         var json_port = $('[id^="PORT_' + trx_name + '"] option:selected').val();
                //         var json_priority = $('[id^="PRIORITY_' + trx_name + '"] option:selected').val();


                //         var content_check = false;
                //         var alert_msg = '';

                //         if ($('#USERID').val() == '' | $('#PASSWORD').val() == ''){
                //             alert_msg = '請輸入NT帳號密碼';
                //         }else{

                //             if (trx_name == 'AUQuitSampling'){

                //                 if (json_note != ''){
                //                     content_check = true;
                //                 }else{
                //                     alert_msg = '請填選NOTE';
                //                 }

                //             }else if (trx_name == 'AUChangeLotPriority'){

                //                 if (json_note != '' & json_priority != ''){
                //                     content_check = true;
                //                 }else{
                //                     alert_msg = '請填選NOTE、PRIORITY';
                //                 }

                //             }else if (trx_name == 'AUHold'){

                //                 if (json_note != '' & json_reasoncode != '' & json_department != ''){
                //                     content_check = true;
                //                 }else{
                //                     alert_msg = '請填選NOTE、REASONCODE、DEPARTMENT';
                //                 }

                //             }else if (trx_name == 'BUDispatchListInfo'){

                //                 if (json_note != '' & json_eqp != '' & json_port != ''){
                //                     content_check = true;
                //                 }else{
                //                     alert_msg = '請填選NOTE、EQP、PORT';
                //                 }

                //             }
                //         }


                //         if (content_check){
                //             $.ajax({ 
                //                 type: 'post', 
                //                 data: 
                //                 {
                //                     username: $('#USERID').val(), 
                //                     password: $('#PASSWORD').val(),
                //                     lot: $('#Hidden_LOT').val(), 
                //                     cst: $('#Hidden_CST').val(), 

                //                     note: json_note, 
                //                     reasoncode: json_reasoncode,
                //                     department: json_department,

                //                     // eqp: $('#EQP_BUDispatchListInfo option:selected').val(),
                //                     // port: $('#PORT_BUDispatchListInfo option:selected').val(),
                //                     // priority: $('#PRIORITY_AUChangeLotPriority option:selected').val(),
                //                     eqp: json_eqp,
                //                     port: json_port,
                //                     priority: json_priority,
                                    
                //                     trx_name: trx_name 
                //                 },
                //                 url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=LigerTangoMES&time=' + Date.now(),                         
                //                 dataType: 'json', 
                //                 success:function(data){

                //                     if(data["msg"] != 'OK'){
                //                         alert(data["msg"]);                                    
                //                     }else{
                //                         $('.close').click();
                //                     }

                //                 },
                //                 error: function(data){
                //                     alert('回傳值有問題' + data);
                //                 },
                //                 complete: function(XMLHttpRequest, textStatus) { 
                //                     // $('.close').click();
                //                 }
                //             });
                //         }else{
                //             alert(alert_msg);
                //         }
                //     }
                    
                    
                // });

            }
            
        }

        function LigerTangoMES(){
            
            var trx_name = $('#exampleModalLabel')[0].innerText;

            // 該填該選的都要有值
            var json_note = $('.MES_POST[id^="NOTE_' + trx_name + '"]').val();
            var json_reasoncode = $('[id^="REASONCODE_' + trx_name + '"] option:selected').val();
            var json_department = $('[id^="DEPARTMENT_' + trx_name + '"] option:selected').val();
            var json_eqp = $('[id^="EQP_' + trx_name + '"] option:selected').val();
            var json_port = $('[id^="PORT_' + trx_name + '"] option:selected').val();
            var json_priority = $('[id^="PRIORITY_' + trx_name + '"] option:selected').val();


            var content_check = false;
            var alert_msg = '';

            if ($('#USERID').val() == '' | $('#PASSWORD').val() == ''){
                alert_msg = '請輸入NT帳號密碼';
            }else{

                if (trx_name == 'AUQuitSampling'){

                    if (json_note != ''){
                        content_check = true;
                    }else{
                        alert_msg = '請填選NOTE';
                    }

                }else if (trx_name == 'AUChangeLotPriority'){

                    if (json_note != '' & json_priority != ''){
                        content_check = true;
                    }else{
                        alert_msg = '請填選NOTE、PRIORITY';
                    }

                }else if (trx_name == 'AUHold'){

                    if (json_note != '' & json_reasoncode != '' & json_department != ''){
                        content_check = true;
                    }else{
                        alert_msg = '請填選NOTE、REASONCODE、DEPARTMENT';
                    }

                }else if (trx_name == 'BUDispatchListInfo'){

                    if (json_note != '' & json_eqp != '' & json_port != ''){
                        content_check = true;
                    }else{
                        alert_msg = '請填選NOTE、EQP、PORT';
                    }

                }else if (trx_name == 'AURelease'){

                    if (json_note != ''){
                        content_check = true;
                    }else{
                        alert_msg = '請填選NOTE';
                    }

                }
            }


            if (content_check){
                $.ajax({ 
                    type: 'post', 
                    data: 
                    {
                        username: $('#USERID').val(), 
                        password: $('#PASSWORD').val(),
                        lot: $('#Hidden_LOT').val(), 
                        cst: $('#Hidden_CST').val(), 

                        note: json_note, 
                        reasoncode: json_reasoncode,
                        department: json_department,

                        // eqp: $('#EQP_BUDispatchListInfo option:selected').val(),
                        // port: $('#PORT_BUDispatchListInfo option:selected').val(),
                        // priority: $('#PRIORITY_AUChangeLotPriority option:selected').val(),
                        eqp: json_eqp,
                        port: json_port,
                        priority: json_priority,
                        
                        trx_name: trx_name 
                    },
                    url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=LigerTangoMES&time=' + Date.now(),                         
                    dataType: 'json', 
                    beforeSend: function () {
                        //將div顯示
                        ShowProgressBar();
                    },
                    success:function(data){

                        if(data["msg"] != 'OK'){
                            alert(data["msg"]);
                        }else{
                            alert('指令傳送成功');

                            $('.close').click();
                            // 把按鈕和Modal清空
                            init();

                            // 還需要把TABLE重置(打勾，紅字清掉)
                            $('#table_WIP').DataTable().ajax.reload();
                        }

                    },
                    error: function(data){
                        alert('回傳值有問題' + data);
                    },
                    complete: function(XMLHttpRequest, textStatus) { 
                        // $('.close').click();
                        // setTimeout(function () { 
                        //     HideProgressBar();
                        // }, 777);
                        HideProgressBar();
                        
                    }
                });
            }else{
                alert(alert_msg);
            }

        }

        function port_cnt(){
            var PORT_BUDispatchListInfo = document.getElementById("PORT_BUDispatchListInfo");
            
            for (i = 0; i < PORT_BUDispatchListInfo.length; i++) {
                var aa = '';
            }

            $.ajax({ 
                type: 'post',  
                data: 
                {
                    SQL: "SELECT eqp_id, total_port FROM report.eqp_port_use_status WHERE eqp_id = 'AKIEX100' GROUP BY eqp_id, total_port"
                },
                url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=MySQL&time=' + Date.now(), 
                dataType: 'json', 
                success:function(data){
                    if(data){
                        
                        var option_null = document.createElement("option");
                        option_null.text = "";
                        PORT_BUDispatchListInfo.add(option_null);

                        for (i = 0; i < data.total_port; i++) {
                            var option_port = document.createElement("option");
                            option_port.text = '0' + (i + 1) ;
                            PORT_BUDispatchListInfo.add(option_port);
                        }

                        
                        
                    }
                }
            }); 
            
        }
        
        function detectBrowser(){
            var browser;
            var isIE = navigator.userAgent.search("MSIE") > -1;
            var isIE7 = navigator.userAgent.search("MSIE") > -1;
            var isFirefox = navigator.userAgent.search("Firefox") > -1;
            var isOpera = navigator.userAgent.search("Opera") > -1;
            var isSafari = navigator.userAgent.search("Safari") > -1;//Google瀏覽器是用這核心
            
            if (isIE7) {
                browser = 'IE7';
            }
            if (isIE) {
                browser = 'IE';
            }
            if (isFirefox) {
                browser = 'Firefox';
            }
            if (isOpera) {
                browser = 'Opera';
            }
            if (isSafari) {
                browser = 'Safari/Chrome';
            }
            return browser;
        }

        function CBclick(obj, samplingType){

            var flag_hold = true;
            var flag_frso = true;
            var flag_dispatch = true;
            var flag_priority = true;
            var flag_release = true;

            var check_cnt = 0;

            // var cst = $('#Hidden_CST').val();

            $('#Hidden_LOT').val('');
            $('#Hidden_CST').val('');


            $(".wip_cb").each(function(index, cb){

                // 在點下去的時候就先認定什麼動作可以做什麼不能做

                // AUQuitSampling：     只要有非SAMPLING站點就不行
                // BUDispatchListInfo： 在機台上貨是非AK就不行
                // AUChangeLotPriority：都沒差？
                // AUHold：             都沒差？

                // AURelease：          要指定HOLD_ID，不能做

                var colDiff = 17 - $('#table_WIP')[0].rows[index + 1].cells.length;
                // 全部欄位是17格，PROD、MODEL、ABBR不一定會少掉幾格
                
                
                if (cb.checked == true){

                    check_cnt += 1;
                    
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].children[0].style.color = "red";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].children[0].style.fontWeight = "777";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].children[0].style.fontSize = "13pt";

                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff + 1].style.color = "red";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff + 1].style.fontWeight = "777";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff + 1].style.fontSize = "13pt";



                    if ($('#Hidden_LOT').val() == ''){
                        $('#Hidden_LOT').val($('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].innerText);
                    }else{
                        $('#Hidden_LOT').val($('#Hidden_LOT').val() + ',' + $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].innerText);
                    }
                    
                    if ($('#Hidden_CST').val() == ''){
                        $('#Hidden_CST').val($('#table_WIP')[0].rows[index + 1].cells[4 - colDiff].innerText);
                    }else{
                        $('#Hidden_CST').val($('#Hidden_CST').val() + ',' + $('#table_WIP')[0].rows[index + 1].cells[4 - colDiff].innerText);
                    }
                    
                    // 能不能HOLD
                    

                    // 能不能FRSO
                    if ($('#table_WIP')[0].rows[index + 1].cells[10 - colDiff].innerText.substr(0,1) != 'S'){
                        flag_frso = false;
                    }else{
                        if ($('#table_WIP')[0].rows[index + 1].cells[6 - colDiff].innerText.indexOf('INPR') > -1){
                            flag_frso = false;
                        }else if (cb.name != 'LTSM' & cb.name != 'EQP_SAMPLING' ){

                            if ( (cb.name == 'EQP_MFG_SAMPLING' || cb.name == 'EQP_MFG_FUTURE_SAMPLING') && 
                                ($('#table_WIP')[0].rows[index + 1].cells[11 - colDiff].innerText == 'AR=LRA' || $('#table_WIP')[0].rows[index + 1].cells[11 - colDiff].innerText == 'PX=STRESS'  || $('#table_WIP')[0].rows[index + 1].cells[11 - colDiff].innerText == 'SL=MOR')){
                                
                            }else{
                                flag_frso = false;
                            }                            
                            
                        }
                    }
                   
                    // 能不能派貨上機台
                    if ($('#table_WIP')[0].rows[index + 1].cells[6 - colDiff].innerText.indexOf('INPR') > -1){
                        flag_dispatch = false;
                    }
                    if ($('#table_WIP')[0].rows[index + 1].cells[6 - colDiff].innerText.indexOf('XFER') > -1){
                        flag_dispatch = false;
                    }
                    if ($('#table_WIP')[0].rows[index + 1].cells[4 - colDiff].innerText.indexOf('AK') == -1){
                        flag_dispatch = false;
                    }

                    // 能不能RELEASE
                    // op_seq = '5960'
                    // hold_reason_code = '7773'
                    // ENGINEER_EXT = 'LTHL'
                    // hold_trans_user like ('AKLSR%')
                    if ($($('#table_WIP')[0].rows[index + 1].cells[6 - colDiff]).attr('onmouseover') == undefined){
                        flag_release = false;
                    }else{
                        if ($($('#table_WIP')[0].rows[index + 1].cells[6 - colDiff]).attr('onmouseover').indexOf('HOLD_ID：') == -1){
                            flag_release = false;
                        }
                    }
                    

                }else{
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].children[0].style.color = "";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].children[0].style.fontWeight = "";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff].children[0].style.fontSize = "";

                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff + 1].style.color = "";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff + 1].style.fontWeight = "";
                    $('#table_WIP')[0].rows[index + 1].cells[3 - colDiff + 1].style.fontSize = "";
                }
            });

            if (check_cnt == 0){
                flag_hold = false;
                flag_frso = false;
                flag_dispatch = false;
                flag_priority = false;
                flag_release = false;
            }

            if (flag_hold){
                $('#BT_AUHold').attr('title', '');
                $('#BT_AUHold').attr('disabled', false);
                $('#BT_AUHold').attr('class', 'btn btn-info');
            }else{
                $('#BT_AUHold').attr('title', '');
                $('#BT_AUHold').attr('disabled', true);
                $('#BT_AUHold').attr('class', 'btn btn-dark');
            }

            if (flag_frso){
                $('#BT_AUQuitSampling').attr('title', '');
                $('#BT_AUQuitSampling').attr('disabled', false);
                $('#BT_AUQuitSampling').attr('class', 'btn btn-info');
            }else{
                // 'LTSM'
                // 'EQP_SAMPLING'
                // 'EQP_MFG_SAMPLING'
                // 'EQP_MFG_FUTURE_SAMPLING'
                $('#BT_AUQuitSampling').attr('title', '有選到非SAMPLING的WIP (只能過EQP_*_SAMPLING / LTSM且不可INPR)');
                $('#BT_AUQuitSampling').attr('disabled', true);
                $('#BT_AUQuitSampling').attr('class', 'btn btn-dark');
            }

            if (flag_dispatch){
                $('#BT_BUDispatchListInfo').attr('title', '');
                $('#BT_BUDispatchListInfo').attr('disabled', false);
                $('#BT_BUDispatchListInfo').attr('class', 'btn btn-info');
            }else{
                $('#BT_BUDispatchListInfo').attr('title', '有INPR的就不能派貨');
                $('#BT_BUDispatchListInfo').attr('disabled', true);
                $('#BT_BUDispatchListInfo').attr('class', 'btn btn-dark');
            }

            if (flag_priority){
                $('#BT_AUChangeLotPriority').attr('title', '');
                $('#BT_AUChangeLotPriority').attr('disabled', false);
                $('#BT_AUChangeLotPriority').attr('class', 'btn btn-info');
            }else{
                $('#BT_AUChangeLotPriority').attr('title', '');
                $('#BT_AUChangeLotPriority').attr('disabled', true);
                $('#BT_AUChangeLotPriority').attr('class', 'btn btn-dark');
            }

            if (flag_release){
                // $('#BT_AURelease').attr('title', '');
                $('#BT_AURelease').attr('disabled', false);
                $('#BT_AURelease').attr('class', 'btn btn-info');
            }else{
                // 只能解LSR Auto Repair的貨
                // $('#BT_AURelease').attr('title', '');
                $('#BT_AURelease').attr('disabled', true);
                $('#BT_AURelease').attr('class', 'btn btn-dark');
            }

        }


        // 顯示讀取遮罩
        function ShowProgressBar() {
            displayProgress();
            displayMaskFrame();
        }

        // 隱藏讀取遮罩
        function HideProgressBar() {
            var progress = $('#divProgress');
            var maskFrame = $("#divMaskFrame");
            progress.hide();
            maskFrame.hide();

            $('#Hidden_rowSpan_CNT').val(0);
        }
        // 顯示讀取畫面
        function displayProgress() {
            var w = $(document).width();
            var h = $(window).height();
            var progress = $('#divProgress');
            progress.css({ "z-index": 999999, "top": (h / 2) - (progress.height() / 2), "left": (w / 2) - (progress.width() / 2) });
            progress.show();
        }
        // 顯示遮罩畫面
        function displayMaskFrame() {
            var w = $(window).width();
            var h = $(document).height();
            var maskFrame = $("#divMaskFrame");
            maskFrame.css({ "z-index": 999998, "opacity": 0.7, "width": w, "height": h });
            maskFrame.show();
        }
        
        function setiFrameHeigth(){
            o = document.getElementsByTagName('iframe');
            for (i = 0; i < o.length; i++) {

                var e = o[i];
                var c = 0;

                do {
                    c ++;                
                } while (o[i] == null && c < 10*100);
                // o[i].contentDocument.body == null && c < 10*100

                try{
                    if (e.contentDocument) {

                        var h = e.contentDocument.body.offsetHeight + 35;
                        var w = e.contentDocument.body.offsetWidth + 35;

                        $(e).animate({
                            height: h,
                            width: w
                        });
                        
                        h = h;
                    } else {

                        var h = e.contentWindow.document.body.scrollHeight + 35;
                        var w = e.contentDocument.body.offsetWidth + 35;
                        
                        $(e).animate({                        
                            height: h,
                            width: w
                        });

                        h = h;
                        w = w;
                    }

                }catch (e){
                    console.log(e);
                }

            }
        }

    </script>
    <style type="text/css">
        
        .highcharts-figure, .highcharts-data-table table
        {
            min-width: 310px;
            max-width: 960px;
            margin: 1em auto;
        }
        
        #container
        {
            height: 400px;
            min-width: 320px;
            max-width: 960px;
            margin: 0 auto;
        }
        
        .highcharts-data-table table
        {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #EBEBEB;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }
        .highcharts-data-table caption
        {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }
        .highcharts-data-table th
        {
            font-weight: 600;
            padding: 0.5em;
        }
        .highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption
        {
            padding: 0.5em;
        }
        .highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even)
        {
            background: #f8f8f8;
        }
        .highcharts-data-table tr:hover
        {
            background: #f1f7ff;
        }
        
        .aspGridView
        {
            font-family: 微軟正黑體;
            font-size: 10pt;
        }
        
        .highcharts-title
        {
            color: #333333;
            border-collapse: collapse;
            font-family: 微軟正黑體;
        }

        .style1
        {
            color: #333333;
            border-collapse: collapse;
            font-family: 微軟正黑體;
        }

        .table.dataTable tbody th, table.dataTable tbody td
        {
            padding: 1px 3px !important;
            border: 1px solid gray ;
        }

        #table_WIP thead tr th, #table_MOVE thead tr th, #table_GROUP thead tr th, #table_GROUP2 thead tr th, #table_FLOW thead tr th, .class_th{
            border: 1px solid gray !important;
            background-color: darkgray;
        }

        #table_WIP tbody tr:hover, #table_MOVE tbody tr:hover, #table_GROUP tbody tr:hover, #table_GROUP2 tbody tr:hover, #table_FLOW tbody tr:hover, .class_td{
            background: #b3d4ff;
        }



        .wip_hold{
            background-color: khaki;
        }

        .wip_inpr{
            background-color: DarkTurquoise;
        }

        .wip_sampling{
            background-color: springgreen;
        }

        .wip_rw{
            background-color: darksalmon;
        }

        .wip_qtime{
            color: red !important;
            font-weight: bold;
        }

        .EQP_MFG_SAMPLING{
            color:white;
            background-color: gray;
        }

        .tooltip_table{
            font-size: 11pt;
        }

        .GROUP_CLOSE{
            color:gray;
            background-color: lightpink;
        }

        .tooltip_table{
            font-size: 9pt;
        }

        .tooltip_table2 td {
            border: 1px solid #000000;
            text-align: center;
            white-space: nowrap;
            padding: 3pt;
        }
 
        
    </style>

    <style type="text/css">
        .tooltip_new {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
        }
        
        .tooltip_new .tooltiptext {
            text-align: center;
            visibility: hidden;
            width: 120px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: -99;
            bottom: 150%;
            left: 50%;
            margin-left: -80px;
        }
        
        .tooltip_new .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: black transparent transparent transparent;
        }
        
        .tooltip_new:hover .tooltiptext {
            visibility: visible;
        }
    </style>
</head>
<body>
    <form id="form1" runat="server">
    <div id="divProgress" style="text-align:center; display: none; position: fixed; top: 50%;  left: 50%;" >
        <asp:Image ID="imgLoading" runat="server" ImageUrl="~/Image/loading.gif" />
        <br />
        <font color="#1B3563" size="5px">資料處理中</font>
    </div>
    <div id="divMaskFrame" style="background-color: #F2F4F7; display: none; left: 0px;
        position: absolute; top: 0px;">
    </div>

    <div id="POP_MSG" style="display: none; padding: 5px; position: absolute; left: 0px;
        top: 0px; z-index: 1; border: 1px solid #888888; background-color: #EEEEEE; font-family: Consolas;
        font-size: 11px; text-align: center">
    </div>
    <button type="button" id="button-test" style="display: none;">
        AJAX TEST</button>
    <button type="button" id="button-demo" style="display: none;" onclick="OPI('')">
        toast TEST</button>
    
    <input type="checkbox" checked id="checkbox" style="display:none;"/>  
    <div class="form-check form-switch" style="display:none;">
        <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" style="display:none;">
        <label class="form-check-label" for="flexSwitchCheckDefault" style="display:none;">Default switch checkbox input</label>
    </div>


    <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="CB('')" >CB</button> -->
    
    <!--
    「data-backdrop="static"」 鎖定背景，點擊背景時不自動關閉視窗
    「fade」 淡入、淡出的轉場效果
    「modal-lg」視窗大小，如modal-lg、modal-md、modal-sm
    「data-dismiss="modal"」 關閉視窗
    「data-keyboard="true"」 是否用ESC鍵關閉，預設為true
    -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>                
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body">
                <table>
                    <tr><td colspan="2"><div id="LOT_List" style="background-color: silver"></div></td></tr>
                    <tr><td style="width:130px">USER_ID：</td><td><input type="text" class="MES_POST" id="USERID"></td></tr>
                    <tr><td style="width:130px">PASS_WORD：</td><td><input type="password" class="MES_POST" id="PASSWORD"></td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
                </table>

                <div id="DIV_AUQuitSampling" class="DIV_MES" style="display:none;">                        
                    <!-- LOT_ID、NOTE                         -->
                    <table>
                        <tr><td style="width:130px">NOTE：</td><td><input type="text" class="MES_POST" id="NOTE_AUQuitSampling"></td></tr>
                    </table>
                </div>

                <div id="DIV_AUChangeLotPriority" class="DIV_MES" style="display:none;">                    
                    <!-- LOT_ID、NOTE、PRIORITY -->
                    <table>
                        <tr><td style="width:130px">NOTE：</td><td><input type="text" class="MES_POST" id="NOTE_AUChangeLotPriority"></td></tr>
                        <tr><td style="width:130px">PRIORITY：</td><td>
                            <select id="PRIORITY_AUChangeLotPriority">
                                <option value=""></option>
                                <option value="NOML">NOML</option>
                                <option value="RUSH">RUSH</option>
                                <option value="SRSH">SRSH</option>
                            </select>
                        </td></tr>
                    </table>
                </div>

                <div id="DIV_AUHold" class="DIV_MES" style="display:none;">
                    <!-- LOT_ID、NOTE、REASONCODE、DEPARTMENT -->
                    <table>
                        <tr><td style="width:130px">NOTE：</td><td><input type="text" class="MES_POST" id="NOTE_AUHold"></td></tr>
                        <tr><td style="width:130px">REASON_CODE：</td><td>
                            <select id="REASONCODE_AUHold">                                
                            </select>
                        </td></tr>
                        <tr><td style="width:130px">DEPARTMENT：</td><td>
                            <select id="DEPARTMENT_AUHold">                                
                            </select>
                        </td></tr>
                    </table>
                </div>

                <div id="DIV_AURelease" class="DIV_MES" style="display:none;">
                    <!-- LOT_ID -->
                    <span style="font-size:12pt ;color: salmon;">
                        目前只可解LSR Auto Repair的HOLD<br>
                        <span style="font-size:10pt">
                            <!-- op_seq = '5960'  <br> -->
                            op_id = 'AR-LSR'  <br>
                            hold_reason_code = '7773'  <br>
                            hold_trans_user LIKE 'AKLSR%' <br>
                            engineer_ext = 'LTHL' 
                        </span>
                    </span>
                    
                    <table>
                        <tr><td style="width:130px">NOTE：</td><td><input type="text" class="MES_POST" id="NOTE_AURelease"></td></tr>
                    </table>
                </div>

                <div id="DIV_BUDispatchListInfo" class="DIV_MES" style="display:none;">
                    <!-- CST、EQP、PORT -->
                    <table>
                        <tr><td style="width:130px">NOTE：</td><td><input type="text" class="MES_POST" id="NOTE_BUDispatchListInfo"></td></tr>
                        <tr><td style="width:130px" onselect="port_cnt()">EQP_ID</td><td>
                            <select id="EQP_BUDispatchListInfo">
                            </select>
                        </td></tr>
                        <tr><td style="width:130px">PORT</td><td>
                            <select id="PORT_BUDispatchListInfo">
                            </select>
                        </td></tr>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="BT_LigerTangoMES" onclick="LigerTangoMES()">UAC驗證</button>
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="stageGroupModal" tabindex="-1" aria-labelledby="stageGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog " style="max-width: 1603px !important">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stageGroupModalLabel"></h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body">
                <table id="table_GROUP2" class="display"  >
                    <thead>
                        <tr>
                            <th>
                                STAGE
                            </th>
                            <th>
                                OPID
                            </th>
                            <th >
                                MODEL
                            </th>
                            <th >
                                ABBR
                            </th>
                            <th>
                                EQP_GROUP
                            </th>
                            <th>
                                LOT_CNT
                            </th>
                            <th>
                                SHEET_QTY
                            </th>
                            <th>
                                EQP_ID
                            </th>
                            <th>
                                ENG_FLAG
                            </th>
                            <th>
                                ENG_USER
                            </th>
                            <th>
                                ENG_TIME
                            </th>
                            <th>
                                MFG_FLAG
                            </th>
                            <th>
                                MFG_USER
                            </th>
                            <th>
                                MFG_TIME
                            </th>
                        </tr>
                    </thead>
                </table>
                <table id="table_FLOW" class="display" style="font-size: 2pt;"  >
                    <thead>
                        <tr>
                            <th >
                                ABBR
                            </th>                            
                            <th>
                                MAIN_ROUTE
                            </th>
                            <th>
                                PEP_LEVEL
                            </th>
                            <th>
                                STAGE
                            </th>
                            <th>
                                OPID
                            </th>
                            <th>
                                GROUP
                            </th>
                            <th>
                                EQP_CNT
                            </th>
                            <th>
                                100
                            </th>
                            <th>
                                200
                            </th>
                            <th>
                                300
                            </th>
                            <th>
                                400
                            </th>
                            <th>
                                500
                            </th>
                            <th>
                                600
                            </th>
                            <th>
                                700
                            </th>
                            <th>
                                800
                            </th>
                            <th>
                                900
                            </th>
                            <th>
                                A00
                            </th>
                            <th>
                                B00
                            </th>
                            <th>
                                C00
                            </th>
                            <th>
                                D00
                            </th>
                            <th>
                                F00
                            </th>
                            <th>
                                G00
                            </th>
                            <th>
                                H00
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="modal-footer">
                
            </div>
            </div>
        </div>
    </div>

    <div id='Div1'>
    </div>
    <table>
        <tr>
            <td style="width: 180px;">                
            </td>
            <td style="vertical-align: top;" >
                <div id="container" style="min-width: 1200px; min-height: 600px; margin: 0 auto">
                </div>
            </td>
            <td style="vertical-align: top;" >
                <div id="DIV_Hold"></div>
            </td>
        </tr>
    </table>

    <!-- <button type="button" class="btn btn-primary" id="liveToastBtn" style="display: none;">
        Show live toast</button>
    <div class="toast" data-autohide="false">
        <div class="toast-header" id="ddd">
            <strong class="mr-auto text-primary">Toast 標題</strong> <small class="text-muted">時間</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">
                ×</button>
        </div>
        <div class="toast-body">
            toast body 內容
        </div>
    </div> -->
    <input id="Hidden_maxY" type="hidden" value="1000" runat="server" />
    <input id="Hidden_minY" type="hidden" value="-1000" runat="server" />
    <input id="Hidden_rowSpan_CNT" type="hidden" value="0" runat="server" />
    <input id="Hidden_series" type="hidden" value="" runat="server" />

    <input id="Search_Model" type="search" placeholder="" readonly="readonly" style="display: none; width: 100px;" />
    <input id="Search_Stage" type="search" placeholder="" readonly="readonly" style="display: none; width: 100px;" />
    <input id="Search_WIP" type="search" placeholder="" readonly="readonly" style="display: none; width: 100px;" />

    <input id="Hidden_CST" type="hidden" value="" runat="server" />
    <input id="Hidden_LOT" type="hidden" value="" runat="server" />

    <input id="Hidden_SLOW" type="hidden" value="" runat="server" />

    <br/>

    <table>
        <tr>
            <td>&nbsp;</td>
            <td>
                <input id="BT_AUQuitSampling"       value="QuitSampling"          onclick="MES('AUQuitSampling')"          type="button" height="35px" class="btn btn-dark" disabled="true" data-bs-toggle="modal" data-bs-target="#exampleModal" />
                &nbsp;
                <input id="BT_AUChangeLotPriority"  value="ChangeLotPriority"     onclick="MES('AUChangeLotPriority')"     type="button" height="35px" class="btn btn-dark" disabled="true" data-bs-toggle="modal" data-bs-target="#exampleModal" />
                &nbsp;
                <input id="BT_AUHold"               value="Hold"                  onclick="MES('AUHold')"                  type="button" height="35px" class="btn btn-dark" disabled="true" data-bs-toggle="modal" data-bs-target="#exampleModal" />                
                &nbsp;
                <input id="BT_BUDispatchListInfo"   value="DispatchListInfo"      onclick="MES('BUDispatchListInfo')"      type="button" height="35px" class="btn btn-dark" disabled="true" data-bs-toggle="modal" data-bs-target="#exampleModal" />
                &nbsp;

                <!-- Release要指定哪一個HOLD，不能在這裡做 -->
                <input id="BT_AURelease"            value="Release"               onclick="MES('AURelease')"               type="button" height="35px" class="btn btn-dark" disabled="true" data-bs-toggle="modal" data-bs-target="#exampleModal" title="目前只可解LSR Auto Repair的HOLD" />
                

            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>
                <table id="table_WIP" class="display"  >
                    <thead>
                        <tr>
                            <th >
                                PROD
                            </th>
                            <th>
                                MODEL
                            </th>
                            <th>
                                ABBR_NO
                            </th>
                            <th>
                                LOT_ID
                            </th>
                            <th>
                                CST
                            </th>
                            <th>
                                SHEET_QTY
                            </th>
                            <th>
                                LOT_STATUS
                            </th>
                            <th>
                                PEPS
                            </th>
                            <th>
                                STAGE_ID
                            </th>
                            <th>
                                PEP_LEVEL
                            </th>
                            <th>
                                ROUTE_ID
                            </th>
                            <th>
                                OP_ID
                            </th>
                            <th>
                                PRIORITY
                            </th>                    
                            <th>
                                HOLD_HOUR
                            </th>
                            <th>
                                QT
                            </th>                    
                            <th >
                                
                            </th>
                            <th>
                                CT
                            </th>
                        </tr>
                    </thead>
                </table>
                <br/>
                <table id="table_GROUP" class="display"  >
                    <thead>
                        <tr>
                            <th>
                                STAGE
                            </th>
                            <th>
                                OPID
                            </th>
                            <th >
                                MODEL
                            </th>
                            <th >
                                ABBR
                            </th>
                            <th>
                                EQP_GROUP
                            </th>
                            <th>
                                LOT_CNT
                            </th>
                            <th>
                                SHEET_QTY
                            </th>
                            <th>
                                EQP_ID
                            </th>
                            <th>
                                ENG_FLAG
                            </th>
                            <th>
                                ENG_USER
                            </th>
                            <th>
                                ENG_TIME
                            </th>
                            <th>
                                MFG_FLAG
                            </th>
                            <th>
                                MFG_USER
                            </th>
                            <th>
                                MFG_TIME
                            </th>
                        </tr>
                    </thead>
                </table>
                <br/>
                <table id="table_MOVE" class="display"  >
                        <thead>
                            <tr>
                                <th >
                                    PROD
                                </th>
                                <th>
                                    MODEL
                                </th>
                                <th>
                                    ABBR_NO
                                </th>
                                <th>
                                    LOT_ID
                                </th>
                                <th>
                                    CST
                                </th>
                                <th>
                                    EQP_ID
                                </th>
                                <th>
                                    STAGE_ID
                                </th>
                                <th>
                                    OP_ID
                                </th>
                                <th>
                                    LOGOFF_SHEET_QTY
                                </th>
                                <th>
                                    PROCESS_SHEET_QTY
                                </th>
                                
                                <th>
                                    LOGON_TIME
                                </th>
                                <th>
                                    EQP_RUN_ID_START_TIME
                                </th>
                                <th>
                                    LOGOFF_TIME
                                </th>                    
                            </tr>
                        </thead>
                </table>
            </td>
            <td>&nbsp;</td>
        </tr>
    </table>


    <asp:GridView ID="GridView_wip" runat="server" CellPadding="4" CssClass="aspGridView"
        ForeColor="#333333" GridLines="Both">
        <FooterStyle BackColor="#5D7B9D" Font-Bold="True" ForeColor="White" />
        <RowStyle BackColor="#F7F6F3" ForeColor="#333333" />
        <EditRowStyle BackColor="#999999" />
        <EmptyDataTemplate>
            <asp:Label ID="Label1" runat="server" Text="無資料"></asp:Label>
        </EmptyDataTemplate>
        <SelectedRowStyle BackColor="#E2DED6" Font-Bold="True" ForeColor="#333333" />
        <PagerStyle BackColor="#284775" ForeColor="White" HorizontalAlign="Center" />
        <HeaderStyle BackColor="#5D7B9D" Font-Bold="True" ForeColor="White" />
        <AlternatingRowStyle BackColor="White" ForeColor="#284775" />
    </asp:GridView>
    <asp:GridView ID="GridView1" runat="server" BackColor="White" BorderColor="#CCCCCC"
        BorderStyle="None" BorderWidth="1px" CellPadding="4" Font-Size="9pt" ForeColor="Black"
        GridLines="Horizontal" style="display: none;"  >
        <FooterStyle BackColor="#CCCC99" ForeColor="Black" />
        <SelectedRowStyle BackColor="#CC3333" Font-Bold="True" ForeColor="White" />
        <PagerStyle BackColor="White" ForeColor="Black" HorizontalAlign="Right" />
        <HeaderStyle BackColor="#404040" Font-Bold="True" ForeColor="White" />
            
    </asp:GridView>

    <br/>
    <br/>
    
    <script type="text/javascript">
        var intervalID;

        var Search_Model = $('#Search_Model');
        var Search_Stage = $('#Search_Stage');
        var Search_WIP = $('#Search_WIP');

        var tableToggle;
        var AHVA_CNT = 7;
        var min_5pep = 7.5;
        var max_5pep = 10.5;
        var min_4pep = 13.5;
        var max_4pep = 15.5;
        var min_ahva = 20.5 + AHVA_CNT;
        var max_ahva = 28.5 + AHVA_CNT;
        var min_coa = 20.5;
        var max_coa = 26.5;
        var min_poa = 39.5 + AHVA_CNT;
        var max_poa = 42.5 + AHVA_CNT;

        var color_4pep = 'rgba(169, 169, 169, 0.5)';
        var color_5pep = 'rgba(169, 169, 169, 0.5)';
        var color_ahva = 'rgba(169, 169, 169, 0.5)';
        var color_coa = 'rgba(169, 169, 169, 0.5)';
        var color_poa = 'rgba(169, 169, 169, 0.5)';

        var color_1 = 'rgba(183, 255, 255, 0.3)';
        var color_2 = 'rgba(198, 184, 255, 0.3)';
        var color_3 = 'rgba(255, 184, 226, 0.3)';
        var color_4 = 'rgba(255, 226, 184, 0.3)';
        var color_5 = 'rgba(198, 255, 184, 0.3)';

        function type_model(tr, input_wip, input_model) {
            //WIP / RW / SAMPLING / MOR
            td = tr.getElementsByTagName('td')[8];
            if (td) {
                if (input_wip.value == 'WIP') {
                    if (td.innerHTML.toUpperCase().substr(0, 1) != 'S' & td.innerHTML.toUpperCase().substr(0, 1) != 'R') {

                        //model
                        td = tr.getElementsByTagName('td')[1];
                        if (td) {
                            if (td.innerHTML.toUpperCase().indexOf(input_model.value.replace('_', '-').toUpperCase()) > -1) {
                                return 'block';
                            } else {
                                return 'none';
                            }
                        }
                    }
                } else if (input_wip.value == 'RW') {
                    if (td.innerHTML.toUpperCase().substr(0, 1) == 'R') {
                        return 'block';
                    }
                } else if (input_wip.value == 'SAMPLING') {
                    if (td.innerHTML.toUpperCase().substr(0, 1) == 'S') {
                        return 'block';
                    }
                } else if (input_wip.value == '') {
                    return 'block';
                }
            }
        }

        function displayNoneALL(gv_id) {
            var table, tr, td, i, j;
            table = document.getElementById(gv_id);
            tr = table.getElementsByTagName('tr');

            for (i = 0; i < tr.length; i++) {

                for (j = 0; j < tr[i].getElementsByTagName('td').length; j++) {

                    tr[i].getElementsByTagName('td')[j].style.display = 'none';

                    tr[i].getElementsByTagName('td')[j].rowSpan = 1;
                    tr[i].getElementsByTagName('td')[j].style.visibility = true;
                }
            }
        }

        // function myFunction(gv_id) {
        //     'use strict';
        //     var td, i, j;

        //     var input_model = document.getElementById('Search_Model');
        //     var input_stage = document.getElementById('Search_Stage');
        //     var input_wip = document.getElementById('Search_WIP');
        //     var table = document.getElementById(gv_id);
        //     var tr = table.getElementsByTagName('tr');

            

        //     for (i = 0; i < tr.length; i++) {

        //         var show_flag = '';

        //         //stage
        //         if (gv_id == 'GridView_wip' | gv_id == 'table_WIP') {
        //             td = tr[i].getElementsByTagName('td')[10];
        //         } else if (gv_id == 'GridView1') {
        //             td = tr[i].getElementsByTagName('td')[2];
        //         }

        //         if (td) {
        //             //                    if (td.innerHTML.toUpperCase().indexOf(input_stage.value.toUpperCase()) > -1) {
        //             // 用indexOf的話像是AAGX / AAGXPS就會混在一起
        //             if (td.innerText.toUpperCase() == input_stage.value.toUpperCase().split('_')[0]) {


        //                 //WIP / RW / SAMPLING / MOR
        //                 if (gv_id == 'GridView_wip' | gv_id == 'table_WIP') {
        //                     td = tr[i].getElementsByTagName('td')[8];
        //                 } else if (gv_id == 'GridView1') {
        //                     td = tr[i].getElementsByTagName('td')[7];
        //                 }
        //                 if (td) {
        //                     if (input_wip.value == 'WIP') {
        //                         if (td.innerText.toUpperCase().substr(0, 1) != 'S' & td.innerText.toUpperCase().substr(0, 1) != 'R') {

        //                             //model
        //                             if (gv_id == 'GridView_wip' | gv_id == 'table_WIP') {
        //                                 td = tr[i].getElementsByTagName('td')[1];
        //                             } else if (gv_id == 'GridView1') {
        //                                 td = tr[i].getElementsByTagName('td')[4];
        //                             }
        //                             if (td) {
        //                                 if (td.innerText.toUpperCase().indexOf(input_model.value.replace('_', '-').toUpperCase()) > -1) {
        //                                     if (gv_id == 'GridView_wip' | gv_id == 'table_WIP') {
        //                                         if (tr[i].getElementsByTagName('td')[11].innerText.toUpperCase().indexOf('MOR') == -1) {
        //                                             show_flag = 'block';
        //                                         }
        //                                     } else if (gv_id == 'GridView1') {
        //                                         if (tr[i].getElementsByTagName('td')[7].innerText.toUpperCase().indexOf('MOR') == -1) {
        //                                             show_flag = 'block';
        //                                         }
        //                                     }
        //                                 }
        //                             }
        //                         }
        //                     } else if (input_wip.value == 'RW') {
        //                         if (td.innerText.toUpperCase().substr(0, 1) == 'R') {
        //                             show_flag = 'block';
        //                         }
        //                     } else if (input_wip.value == 'SAMPLING') {
        //                         if (td.innerText.toUpperCase().substr(0, 1) == 'S') {
        //                             show_flag = 'block';
        //                         }
        //                     } else if (input_wip.value == 'MOR') {
        //                         if (tr[i].getElementsByTagName('td')[11].innerText.toUpperCase().indexOf('MOR') > -1) {
        //                             show_flag = 'block';
        //                         }
        //                     } else if (input_wip.value == '') {
        //                         show_flag = 'block';
        //                     }
        //                 }

        //             } else {

        //                 //input_stage.value.toUpperCase()                        
        //                 if (input_stage.value.toUpperCase().indexOf('_') > -1) {
        //                     if (input_stage.value.toUpperCase().indexOf('PEP') > -1) {

        //                         if (tr[i].getElementsByTagName('td')[10].innerText.toUpperCase() == 'ETAS') {
        //                             if (input_stage.value.toUpperCase() == 'ETAS_5PEP' & tr[i].getElementsByTagName('td')[9].innerText.toUpperCase() == 'PEP2') {
        //                                 //ETAS_5PEP                                        
        //                                 show_flag = type_model(tr[i], input_wip, input_model);
        //                             } else if (input_stage.value.toUpperCase() == 'ETAS_4PEP' & tr[i].getElementsByTagName('td')[9].innerText.toUpperCase() == 'PEP3') {
        //                                 //ETAS_4PEP
        //                                 show_flag = type_model(tr[i], input_wip, input_model);
        //                             } else {
        //                                 show_flag = 'none';
        //                             }
        //                         } else {
        //                             show_flag = 'none';
        //                         }

        //                     } else {

        //                         if (input_stage.value.toUpperCase() == 'ETNC_NL' & (tr[i].getElementsByTagName('td')[10].innerText.toUpperCase() == 'ETNC' | tr[i].getElementsByTagName('td')[10].innerText.toUpperCase() == 'ETNL')) {
        //                             //ETNC_NL
        //                             show_flag = type_model(tr[i], input_wip, input_model);
        //                         } else if (input_stage.value.toUpperCase() == 'STNC_NL' & (tr[i].getElementsByTagName('td')[10].innerText.toUpperCase() == 'STNC' | tr[i].getElementsByTagName('td')[10].innerText.toUpperCase() == 'STNL')) {
        //                             //STNC_NL
        //                             show_flag = type_model(tr[i], input_wip, input_model);
        //                         } else {
        //                             show_flag = 'none';
        //                         }

        //                     }
        //                 } else {

        //                     show_flag = 'none';

        //                 }

        //                 //show_flag = 'none';
        //             }

        //         }


        //         if (show_flag == 'block') {

        //             for (j = 0; j < tr[i].getElementsByTagName('td').length; j++) {
        //                 tr[i].getElementsByTagName('td')[j].style.display = '';
        //             }
                    
        //         } else if (show_flag == 'none') {
        //             for (j = 0; j < tr[i].getElementsByTagName('td').length; j++) {
        //                 tr[i].getElementsByTagName('td')[j].style.display = 'none';
        //             }
        //         } else {
        //             for (j = 0; j < tr[i].getElementsByTagName('td').length; j++) {
        //                 tr[i].getElementsByTagName('td')[j].style.display = 'none';
        //             }
        //         }

        //     }

        // } 


        function testSpan(gv_id, tr, col, temp, temp_i, temp_rowspan){
            for (i = 0; i < tr.length; i++) {
                if (tr[i].getElementsByTagName('td').length > 0){
                    if (tr[i].getElementsByTagName('td')[0].innerText != 'Loading...' & tr[i].getElementsByTagName('td')[0].innerText != 'No data available in table'){
                        if (tr[i].getElementsByTagName('td')[1].style.display != 'none'){

                            if ((gv_id == 'table_GROUP' | gv_id == 'table_GROUP2') & (col == 6 | col == 5 | col == 4)){
                                // SHEET_QTY、LOT_CNT跟著EQP_GROUP走
                                if (temp == ''){                        
                                    temp = tr[i].getElementsByTagName('td')[3].innerText;
                                    temp_i = i;
                                    temp_rowspan = 1;

                                }else{

                                    if (temp == tr[i].getElementsByTagName('td')[3].innerText){
                                        // 遇到一樣的，先設定上去
                                        temp_rowspan = temp_rowspan + 1;
                                        
                                        tr[temp_i].getElementsByTagName('td')[col].rowSpan = temp_rowspan;
                                        tr[i].getElementsByTagName('td')[col].remove();

                                    }else{
                                        // 不一樣，temp清空                            
                                        temp = tr[i].getElementsByTagName('td')[3].innerText;
                                        temp_i = i;
                                        temp_rowspan = 1;
                                        
                                    }
                                }

                            }else{

                                if (temp == ''){                        
                                    temp = tr[i].getElementsByTagName('td')[col].innerText;
                                    temp_i = i;
                                    temp_rowspan = 1;

                                }else{

                                    if (temp == tr[i].getElementsByTagName('td')[col].innerText){
                                        // 遇到一樣的，先設定上去
                                        temp_rowspan = temp_rowspan + 1;
                                        
                                        tr[temp_i].getElementsByTagName('td')[col].rowSpan = temp_rowspan;
                                        tr[i].getElementsByTagName('td')[col].remove();

                                    }else{
                                        // 不一樣，temp清空                            
                                        temp = tr[i].getElementsByTagName('td')[col].innerText;
                                        temp_i = i;
                                        temp_rowspan = 1;
                                        
                                    }
                                }
                            }

                        } 
                    }
                }
            }
        }

        function setRowSpan(gv_id) {

            ShowProgressBar();
            
            var browser = detectBrowser();
            var table = document.getElementById(gv_id);
            var tr = table.getElementsByTagName('tr');


            if (parseInt($('#Hidden_rowSpan_CNT').val()) == 0){
                
                if (browser != undefined & browser != 'IE'){
                
                    var temp_col1 = '';
                    var temp_col1_i = 0;
                    var temp_col1_rowspan = 1;

                    var temp_col2 = '';
                    var temp_col2_i = 0;
                    var temp_col2_rowspan = 1;

                    var temp_col3 = '';
                    var temp_col3_i = 0;
                    var temp_col3_rowspan = 1;

                    var temp_col4 = '';
                    var temp_col4_i = 0;
                    var temp_col4_rowspan = 1;

                    if (gv_id.indexOf('table_GROUP') == 0){   
                        testSpan(gv_id, tr, 6, '', 0, 1);
                        testSpan(gv_id, tr, 5, '', 0, 1);
                        testSpan(gv_id, tr, 4, '', 0, 1);
                        testSpan(gv_id, tr, 3, '', 0, 1);
                    }
                    // if (gv_id == 'table_FLOW'){   
                    //     testSpan(gv_id, tr, 3, '', 0, 1);
                    // }

                    testSpan(gv_id, tr, 2, temp_col3, temp_col3_i, temp_col3_rowspan);
                    testSpan(gv_id, tr, 1, temp_col2, temp_col2_i, temp_col2_rowspan);
                    testSpan(gv_id, tr, 0, temp_col2, temp_col2_i, temp_col2_rowspan);


                    $('#Hidden_rowSpan_CNT').val(parseInt($('#Hidden_rowSpan_CNT').val()) + 1);
                    // console.log('setRowSpan：' + Date.now());
                }

            }


            if (gv_id.indexOf('table_GROUP') == -1){
                for (i = 0; i < tr.length; i++) {
                if (tr[i].getElementsByTagName('td').length > 0){
                    if (tr[i].getElementsByTagName('td')[0].innerText != 'Loading...' & tr[i].getElementsByTagName('td')[0].innerText != 'No data available in table'){
                        
                        var col_gap = 17 - tr[i].getElementsByTagName('td').length;
                        
                        if (tr[i].getElementsByTagName('td')[6 - col_gap].innerText.indexOf('HLDL') == 0){

                            if ($(tr[i].getElementsByTagName('td')[6 - col_gap]).attr('onmouseover') == undefined){

                                var lot = tr[i].getElementsByTagName('td')[3 - col_gap].innerText;
                                var cst = tr[i].getElementsByTagName('td')[4 - col_gap].innerText;
                                var hold_data = HoldInfo(lot, cst);
                                var holdID = '';
                                

                                var tooltip_str = '';                                
                                tooltip_str = '<table border=1 class=tooltip_table>';
                                tooltip_str += '<tr>';
                                tooltip_str += '<th>HOLD_TIME</th>';
                                tooltip_str += '<th>HOLD_HOUR</th>';
                                tooltip_str += '<th>RESPONSE_DEPT</th>';
                                tooltip_str += '<th>REQUEST_USER</th>';
                                tooltip_str += '<th>HOLD_TRANS_USER</th>';
                                tooltip_str += '<th>HOLD_NOTE</th>';
                                tooltip_str += '<th>CNT</th>';
                                tooltip_str += '</tr>';
                                hold_data.forEach(function(row, index) {
                                    tooltip_str += '<tr>';
                                    tooltip_str += '<td nowrap=nowrap>' + row["HOLD_TIME"] + '</td>';
                                    tooltip_str += '<td nowrap=nowrap>' + parseFloat(row["HOLD_HOUR"]).toFixed(1) + '</td>';
                                    tooltip_str += '<td nowrap=nowrap>' + row["RESPONSE_DEPT"] + '</td>';
                                    tooltip_str += '<td nowrap=nowrap>' + row["REQUEST_USER"] + '</td>';
                                    tooltip_str += '<td nowrap=nowrap>' + row["HOLD_TRANS_USER"] + '</td>';
                                    tooltip_str += '<td>' + row["HOLD_NOTE"] + '</td>';
                                    tooltip_str += '<td>' + row["HOLD_CNT"] + '</td>';                                
                                    tooltip_str += '</tr>';

                                    if (row["HOLD_ID"] != '-'){
                                        holdID = row["HOLD_ID"];
                                    }
                                });
                                tooltip_str += '</table>';
                                if (holdID != ""){
                                    tooltip_str += '<br/>HOLD_ID：' + holdID;
                                }



                                var hold_str = '';
                                hold_data.forEach(function(row, index) {
                                    if (hold_str != ''){
                                        hold_str += ' <br/> ';    
                                    }
                                    hold_str += '' + parseFloat(row["HOLD_HOUR"]).toFixed(1) + ' ';
                                    // hold_str += '' + row["REQUEST_USER"].replace('ML8B', '') + '';
                                    hold_str += '【' + row["RESPONSE_DEPT"] + '】';

                                    if (row["HOLD_NOTE"].length > 12){
                                        hold_str += '' + row["HOLD_NOTE"].substr(0, 9) + '...';
                                    }else{
                                        hold_str += '' + row["HOLD_NOTE"] + '';
                                    }
                                    
                                });




                                $(tr[i].getElementsByTagName('td')[6 - col_gap]).attr('onmouseover','display_popup(event, "' + tooltip_str + '")');
                                $(tr[i].getElementsByTagName('td')[6 - col_gap]).attr('onmouseout','display_popup(event, "")');

                                $(tr[i].getElementsByTagName('td')[13 - col_gap]).attr('onmouseover','display_popup(event, "' + tooltip_str + '")');
                                $(tr[i].getElementsByTagName('td')[13 - col_gap]).attr('onmouseout','display_popup(event, "")');


                                tr[i].getElementsByTagName('td')[13 - col_gap].innerText = '';
                                
                                const textNode = document.createElement('span');
                                textNode.innerHTML = hold_str;
                                textNode.style = "font-size: 11pt; ";
                                tr[i].getElementsByTagName('td')[13 - col_gap].appendChild(textNode);                            
                                $(tr[i].getElementsByTagName('td')[13 - col_gap]).removeClass('text-center').addClass('text-left');



                            }
                            
                        }
                        
                    }
                }
            }
            }
            // console.log('#1842：' + '7');
            setTimeout(function(){
                HideProgressBar();
            }, 7);

        }

        function HoldInfo(lot, cst){
            var result = 'hold';

            $.ajax({
                type: 'post',  
                async : false,
                data: 
                {
                    SQL: "SELECT " + 
                        "	a.lot_id, " +
                        "	a.cassette_id, " +
                        "	a.op_id, " +
                        "	b.response_dept, " +
                        "	CASE WHEN c.user_name IS NULL THEN b.hold_trans_user ELSE c.department || '_' || c.user_name END AS hold_trans_user, " +
                        "	CASE WHEN d.user_name IS NULL THEN b.request_user ELSE d.department || '_' || d.user_name END AS request_user, " +
                        // "	TO_CHAR(b.hold_trans_timestamp, 'mm-dd hh24:mi') AS hold_time, " +
                        // "	ROUND(TO_NUMBER(EXTRACT(DAY FROM((CURRENT_TIMESTAMP - b.hold_trans_timestamp) * 24 * 60 * 60))) / 3600, 1) AS hold_hour, " +
                        "	TO_CHAR(MIN(b.hold_trans_timestamp), 'mm-dd hh24:mi') || ' ~ ' || TO_CHAR(MAX(b.hold_trans_timestamp), 'mm-dd hh24:mi') AS hold_time, " + 
                        "	ROUND(TO_NUMBER(EXTRACT(DAY FROM((CURRENT_TIMESTAMP - MIN(b.hold_trans_timestamp)) * 24 * 60 * 60))) / 3600, 1) || ' ~ ' || ROUND(TO_NUMBER(EXTRACT(DAY FROM((CURRENT_TIMESTAMP - MAX(b.hold_trans_timestamp)) * 24 * 60 * 60))) / 3600, 1) AS hold_hour, " +
                        "	b.hold_note ," +
                        // "	b.hold_id " +
                        "	COUNT(b.hold_id) AS hold_cnt, " +
                        "	CASE WHEN a.cassette_id = 'AA0350' " +
                        "		OR " +
                        "		( " +
                        //"			a.op_seq = '5960'  " +
                        "			a.op_id = 'AR-LSR'  " +
                        "		AND b.hold_reason_code = '7773'  " +
                        "		AND b.hold_trans_user LIKE 'AKLSR%' " +
                        "		AND b.engineer_ext = 'LTHL' " + 
                        "		) " +
                        "	THEN b.hold_id END AS hold_id " +
                        "FROM aryods.r_lot_wip_ods a JOIN aryods.h_lot_holdrelease_ods b " +
                        "ON a.cassette_id = b.cassette_id " +
                        "	AND a.lot_id = b.lot_id " +
                        "LEFT JOIN aryods.c_fac_user_mst c " +
                        "ON b.hold_trans_user = c.user_id " +
                        "LEFT JOIN aryods.c_fac_user_mst d " +
                        "ON b.request_user = d.user_id " +
                        "WHERE a.lot_status = 'HLDL' " + 
                        "	AND a.lot_id = '" + lot + "' " +
                        "	AND b.release_trans_timestamp IS NULL " +
                        "GROUP BY a.lot_id, " +
                        "	a.cassette_id, " +
                        "	a.op_id, " +
                        "	b.response_dept, " +
                        "	CASE WHEN c.user_name IS NULL THEN b.hold_trans_user ELSE c.department || '_' || c.user_name END , " +
                        "	CASE WHEN d.user_name IS NULL THEN b.request_user ELSE d.department || '_' || d.user_name END , " +
                        // "	TO_CHAR(b.hold_trans_timestamp, 'mm-dd hh24:mi'), " +
                        // "	ROUND(TO_NUMBER(EXTRACT(DAY FROM((CURRENT_TIMESTAMP - b.hold_trans_timestamp) * 24 * 60 * 60))) / 3600, 1) , " +
                        "	b.hold_note, " +
                        "	CASE WHEN a.cassette_id = 'AA0350' " +
                        "		OR " +
                        "		( " +
                        // "			a.op_seq = '5960'  " +
                        "			a.op_id = 'AR-LSR'  " +
                        "		AND b.hold_reason_code = '7773'  " +
                        "		AND b.hold_trans_user LIKE 'AKLSR%' " +
                        "		AND b.engineer_ext = 'LTHL' " + 
                        "		) " +
                        "	THEN b.hold_id END " +
                        "ORDER BY TO_CHAR(MIN(b.hold_trans_timestamp), 'mm-dd hh24:mi') "
                },
                
                url: 'http://tw100018633.corpnet.auo.com/json/Json.ashx?json=SQL&time=' + Date.now(), 
                dataType: 'json', 
                success:function(data){
                    // console.log(data);

                    // var rtn = '';
                    // rtn = '<table border=1 >';
                    // rtn += '<tr>';
                    // rtn += '<th>RESPONSE_DEPT</th>';
                    // rtn += '<th>REQUEST_USER</th>';
                    // rtn += '<th>HOLD_TRANS_USER</th>';
                    // rtn += '<th>HOLD_NOTE</th>';
                    // rtn += '<th>HOLD_TIME</th>';
                    // rtn += '</tr>';
                    // data.forEach(function(row, index) {
                    //     rtn += '<tr>';
                    //     rtn += '<td>' + row["RESPONSE_DEPT"] + '</td>';
                    //     rtn += '<td>' + row["REQUEST_USER"] + '</td>';
                    //     rtn += '<td>' + row["HOLD_TRANS_USER"] + '</td>';
                    //     rtn += '<td>' + row["HOLD_NOTE"] + '</td>';
                    //     rtn += '<td>' + row["HOLD_TIME"] + '</td>';
                    //     rtn += '</tr>';
                    // });
                    // rtn += '</table>';
                    
                    

                    result = data;
                    
                },
                error:function(err){
                    console.log(err);                                        
                },
                complete: function(XMLHttpRequest, textStatus) { 
                    
                }
            });
            
            return result;
        }

    </script>
    </form>
    
    <script type="text/javascript">

        function stageGroupModal(stage){

            var options_groupTable = {
                "ajax":{},
                "paging": false,
                "orderCellsTop": true,
                "fixedHeader": true,
                "dom": 'Brtp',    //<"toolbar">C<"clear">lBrtip
                "ordering": false,
                "oLanguage": {
                    "sSearch": "關鍵字查詢:",
                    "sProcessing": "正在讀取資料...",
                    "sLengthMenu": "顯示 _MENU_ 筆資訊"
                },
                "processing": true, //顯示資料處理狀態
                "destroy": true,
                "retrieve": true,
                "colVis": {
                    "buttonText": "隱藏/顯示欄位"

                },
                "autoWidth": false,
                "columns": [
                    { data: 'STAGE_ID' },
                    { data: 'OP_ID'},
                    { data: 'MODEL_NO' },
                    { data: 'ABBR_NO' },
                    { data: 'EQP_GROUP',
                        // render: function (data, type, row, meta) { 
                        //     return '<a href="Route_Info.aspx?ROUTE_ID=' + data + '"" target="_blank">' + data + '</a>';
                        // }
                    },
                    { data: 'LOT_CNT'},
                    { data: 'SHEET_QTY'},
                    { data: 'EQP_ID',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'ENG_ENABLED_FLAG',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                            if (rowData["ENG_ENABLED_FLAG"] == 'N'){
                                $(td).addClass('wip_qtime');
                            } 
                        },
                    },
                    { data: 'ENG_LM_USER',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'ENG_LM_TIME',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'MFG_ENABLED_FLAG',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            }
                            if (rowData["MFG_ENABLED_FLAG"] == 'N'){
                                $(td).addClass('wip_qtime');
                            } 
                        },
                    },
                    { data: 'MFG_LM_USER',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'MFG_LM_TIME',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData["IS_ENABLED"] == 'N'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                ],
                "order": [[ 0, 'desc' ], [ 1, 'asc' ], [ 2, 'asc' ], [ 3, 'asc' ]],
                "columnDefs":[
                    // row.LOT_STATUS
                    // meta.col
                    {
                        targets: '_all',
                        className: 'text-center text-nowrap'
                    },

                ],

            }

            var group_ajax = {
                type: "POST",

                data: function(d) {
                    $('#Hidden_rowSpan_CNT').val(0);

                    return $.extend({}, d, {
                        // "stage" : $('#Search_Stage').val()
                        "stage" : stage
                    });
                },
                
                url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=STAGE_MODEL_GROUP&time=" + Date.now() + 
                    "&stage=" + 
                    "&model=" + 
                    "&wip=" + 
                    "&data=data",

                // success: function (data) {
                //     console.log('ajax success');
                // },
                error: function (jqXHR, exception) {

                    var msg = '';
                    if (jqXHR.status === 0) {
                        msg = 'Not connect.\n Verify Network.';
                    } else if (jqXHR.status == 404) {
                        msg = 'Requested page not found. [404]';
                    } else if (jqXHR.status == 500) {
                        msg = 'Internal Server Error [500].';
                    } else if (exception === 'parsererror') {
                        msg = 'Requested JSON parse failed.';
                    } else if (exception === 'timeout') {
                        msg = 'Time out error.';
                    } else if (exception === 'abort') {
                        msg = 'Ajax request aborted.';
                    } else {
                        msg = 'Uncaught Error.\n' + jqXHR.responseText;
                    }
                    
                    console.log('ajax error：' + msg);
                }

            }
            options_groupTable.ajax = group_ajax;
            var group_datatables = $('#table_GROUP2').DataTable(options_groupTable);
            
            $('#stageGroupModal .modal-dialog').attr('style', 'max-width: 1559px !important')
            document.getElementById('table_GROUP2').style.display = "block";
            document.getElementById('table_FLOW').style.display = "none";
            group_datatables.ajax.reload(function(json){

                console.log('group_ajax');

                setTimeout(function(){
                    setRowSpan('table_GROUP2');
                    $('#Hidden_DrillData').val(0);
                }, 7);
            });


            $("#stageGroupModal").modal("show");
        }

        function modelGroupModal(model){

            $('#Search_Model').val(model);

            // 2022-07-13
            var options_flow = {
                "ajax":{},
                "paging": false,
                "orderCellsTop": true,
                "fixedHeader": true,
                "dom": 'Brtp',    //<"toolbar">C<"clear">lBrtip
                "ordering": false,
                "oLanguage": {
                    "sSearch": "關鍵字查詢:",
                    "sProcessing": "正在讀取資料...",
                    "sLengthMenu": "顯示 _MENU_ 筆資訊"
                },
                "processing": true, //顯示資料處理狀態
                "destroy": true,
                "retrieve": true,
                "colVis": {
                    "buttonText": "隱藏/顯示欄位"

                },
                "autoWidth": false,
                "columns": [                    
                    { data: 'ABBR_NO' },                    
                    { data: 'MAIN_ROUTE_ID',
                        render: function (data, type, row, meta) { 
                            return '<a href="Route_Info.aspx?ROUTE_ID=' + data + '" target="_blank">' + data + '</a>';
                        }
                    },
                    { data: 'PEP_LEVEL'},
                    { data: 'STAGE_ID',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData['EQP_CNT'] == '0'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'OP_ID',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData['EQP_CNT'] == '0'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'EQP_GROUP',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData['EQP_CNT'] == '0'){
                                $(td).addClass('GROUP_CLOSE');
                            } 
                        },
                    },
                    { data: 'EQP_CNT',
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (cellData == '0'){
                                $(td).addClass('wip_qtime');
                            } 
                        },
                    },
                    { data: 'EQP_100',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_200',render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_300',render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_400',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_500',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_600',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_700',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_800',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_900',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_A00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_B00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_C00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_D00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_F00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_G00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                    { data: 'EQP_H00',
                        render: function (data, type, row, meta) { 
                            if (data == 0){
                                return '';
                            }else{
                                return '◎';
                            }
                        }
                    },
                ],
                "order": [[ 0, 'desc' ], [ 1, 'asc' ], [ 2, 'asc' ], [ 3, 'asc' ]],
                "columnDefs":[
                    // row.LOT_STATUS
                    // meta.col
                    {
                        targets: '_all',
                        className: 'text-center text-nowrap'
                    },

                ],

            }
            
            var flow_ajax = {
                type: "POST",                

                data: function(d) {
                    $('#Hidden_rowSpan_CNT').val(0);

                    return $.extend({}, d, {
                        "model" : $('#Search_Model').val(),
                        "time" : Date.now()
                    });
                },
                cache:false, 
                url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=STAGE_MODEL_GROUP&time=" + Date.now() +
                    "&stage=" + 
                    "&model=" + 
                    "&wip=" + 
                    "&data=data",

                error: function (error) {
                    console.log('ajax error：' + error);
                },
                complete: function () {
                    // setTimeout(function(){
                    //     setRowSpan(table_name, true);
                    // }, 7000);
                    // console.log('flow_ajax：' + model);
                }
            }

            
            options_flow.ajax = flow_ajax;
            var flow_datatables = $('#table_FLOW').DataTable(options_flow);
            
            $('#stageGroupModal .modal-dialog').attr('style', 'max-width: 1603px !important')
            document.getElementById('table_GROUP2').style.display = "none";
            document.getElementById('table_FLOW').style.display = "block";
            flow_datatables.ajax.reload(function(json){

                console.log('flow_ajax:' + model);

                setTimeout(function(){
                    setRowSpan('table_FLOW');
                    $('#Hidden_DrillData').val(0);
                }, 7);
            });

            $("#stageGroupModal").modal("show");

        }

        
        var maxY = 2000;
        var minY = -1000;
        var datatables;
        var table_name;
        const map_color = new Map();



        function requestData(slow){

            requesCOLOR();
            if (slow == ''){
                requesMaxMin();
            }


            // options.yAxis[1].max = 0; 
            // options.yAxis[1].min = 0;

            if (datatables != ''){

                if (datatables != undefined){
                    // console.log('#3052：' + '7');
                    setTimeout(function(){

                        datatables.ajax.reload(function(json){

                        // console.log('#3057：' + '7');
                        setTimeout(function(){
                            setRowSpan(table_name);
                            }, 7);
                        });

                    }, 7);
                }

            }

            $.ajax({ 
                type:"get",  
                url:"http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_CHART&slow=" + slow,
                dataType:'json', 
                success:function(data){
                    if(data){            

                        $.each(options.series, function(num, series) {
                            options.series.pop(series);
                        });
                        

                        var series_null = {
                            name: 'NULL',
                            yAxis: 0,
                            showInLegend: false,
                            type: 'column',                        
                            marker: {
                                enabled: false
                            },
                            data: []
                        };
                        var series_sampling = {
                            name: 'sampling',
                            yAxis: 0,
                            type: 'column',
                            color: '#5BFF5C',
                            marker: {
                                enabled: false
                            },
                            data: []
                        };
                        var series_mor = {
                            name: 'mor',
                            yAxis: 0,
                            type: 'column',
                            color: '#87CEFA',
                            marker: {
                                enabled: false
                            },
                            data: []
                        };
                        var series_rw = {
                            name: 'rw',
                            yAxis: 0,                        
                            type: 'column',
                            color: '#FA6869',
                            marker: {
                                enabled: false
                            },
                            data: []
                        };

                        var series_TARGET = {
                            name: 'TARGET',
                            yAxis: 0,
                            type: 'spline',
                            marker: {
                                enabled: false
                            },
                            color: '#0000FF',
                            dashStyle: 'LongDash',
                            data: []
                        };

                        var series_D1 = {
                            name: 'D1',
                            yAxis: 0,
                            type: 'spline',
                            color: '#999900',
                            marker: {
                                enabled: false
                            },                                        
                            data: []
                        };
                        var series_D2 = {
                            name: 'D2',
                            yAxis: 0,
                            type: 'spline',
                            color: '#FFD700',
                            marker: {
                                enabled: false
                            },                                        
                            data: []
                        };
                        var series_N1 = {
                            name: 'N1',
                            yAxis: 0,
                            type: 'spline',
                            color: '#00FF00',
                            marker: {
                                enabled: false
                            },                                        
                            data: []
                        };
                        var series_N2 = {
                            name: 'N2',
                            yAxis: 0,
                            type: 'spline',
                            color: '#FF0000',
                            marker: {
                                enabled: false
                            },
                            data: []
                        };
                    
                        var series_model = [];
                        var str_model = ''

                        var now_date = new Date(new Date() - 450*60*1000);
                        var D2_flag = false;
                        var N1_flag = false;
                        var N2_flag = false;

                        if (now_date.getHours() >= 6){
                            D2_flag = true;

                            if (now_date.getHours() >= 12){
                                N1_flag = true;
                                
                                if (now_date.getHours() >= 18){
                                    N2_flag = true;

                                }
                            }
                        }

                        $.each(data, function(num, data) {

                            options.title.text = '《L8B ARRAY KSR 2.0》更新時間：' + data['update_time'] ;
                            // options.title.text += '<button type="button" id="button-slow" onclick="alert()">TEST</button>';

                            options.xAxis.categories.push(data['stage_id']);

                            var null_data = {
                                name: data['stage_id'],
                                y: 0,
                                drilldown: data['stage_id'] + '##',
                            };
                            series_null.data.push(null_data);


                            var sampling_data = {
                                name: data['stage_id'],
                                y: Number(data['sampling']),
                                drilldown: data['stage_id'] + '#sampling#SAMPLING',
                            };
                            series_sampling.data.push(sampling_data);


                            var mor_data = {
                                name: data['stage_id'],
                                y: Number(data['mor']),
                                drilldown: data['stage_id'] + '#mor#MOR',
                            };
                            series_mor.data.push(mor_data);


                            var rw_data = {
                                name: data['stage_id'],
                                y: Number(data['rw']),
                                drilldown: data['stage_id'] + '#rw#RW',
                            };
                            series_rw.data.push(rw_data);

                            
                            var target_data = {
                                name: data['stage_id'],
                                y: Number(data['target_move']),                                        
                                color:  '#' + map_color.get('TARGET_MOVE'),
                            };
                            series_TARGET.data.push(target_data);


                            var D1_data = {
                                name: data['stage_id'],
                                y: Number(data['D1']),
                                drilldown: data['stage_id'] + '#D1#MOVE',
                                color:  '#' + map_color.get(data['D1']),
                            };
                            series_D1.data.push(D1_data);


                            if (D2_flag){
                                var D2_data = {
                                    name: data['stage_id'],
                                    y: Number(data['D2']),
                                    drilldown: data['stage_id'] + '#D2#MOVE',
                                };
                                series_D2.data.push(D2_data);                                    
                            }else{
                                var D2_data = {
                                    name: data['stage_id'],                                        
                                    drilldown: data['stage_id'] + '#D2#MOVE',
                                };
                                series_D2.data.push(D2_data);
                            }
                            
                            if (N1_flag){
                                var N1_data = {
                                    name: data['stage_id'],
                                    y: Number(data['N1']),
                                    drilldown: data['stage_id'] + '#N1#MOVE',                              
                                };
                                series_N1.data.push(N1_data);
                            }else{
                                var N1_data = {
                                    name: data['stage_id'],                                        
                                    drilldown: data['stage_id'] + '#N1#MOVE',                              
                                };
                                series_N1.data.push(N1_data);
                            }
                            
                            if (N2_flag){
                                var N2_data = {
                                    name: data['stage_id'],
                                    y: Number(data['N2']),
                                    type: 'column',
                                    drilldown: data['stage_id'] + '#N2#MOVE',
                                };
                                series_N2.data.push(N2_data);

                            }else{
                                var N2_data = {
                                    name: data['stage_id'],                                        
                                    type: 'column',
                                    drilldown: data['stage_id'] + '#N2#MOVE',
                                };
                                series_N2.data.push(N2_data);

                            }
                            


                            var temp_str = 'update_time, stage_id, stage_seq, sampling, mor, rw, target_move, D1, D2, N1, N2';
                            $.each(data, function(itemName, value) {

                                itemName = itemName.trim();

                                if (temp_str.indexOf(itemName) < 0){

                                    if (str_model.indexOf(itemName) < 0){

                                        var color = '';
                                        if (map_color.get(itemName) !== '未設定'){
                                            color = '#' + map_color.get(itemName);
                                        }


                                        var series_temp = {
                                            name: itemName,
                                            yAxis: 0,
                                            // pointWidth: 13,
                                            type: 'column',
                                            marker: {
                                                enabled: false
                                            },
                                            data: [],
                                            drilldown: [],
                                            color: color,
                                        };
                                
                                        series_model.push(series_temp);
                                        str_model += ',' + itemName;

                                    }                                            
                                    
                                }
                            });
                        });

                        $.each(series_model, function(num, series) {
                            var test = num;

                            $.each(data, function(num, data) {

                                var temp_data = {
                                    // name: data['stage_id'],
                                    name: data['name'],
                                    y: Number(data[series["name"]]),
                                    drilldown: data['stage_id'] + '#' + series["name"] + '#WIP',
                                };

                                series.data.push(temp_data);
                            });
                            
                            options.series.push(series);
                        });
                        


                        options.series.push(series_sampling);
                        options.series.push(series_mor);
                        options.series.push(series_rw);                            
                        if (slow == ''){
                            options.series.push(series_TARGET);
                            options.series.push(series_D1);
                            // options.series.push(series_D2);
                            // options.series.push(series_N1);
                            // options.series.push(series_N2);
                            if (D2_flag){
                                options.series.push(series_D2);
                            }
                            if (N1_flag){
                                options.series.push(series_N1);
                            }
                            if (N2_flag){
                                options.series.push(series_N2);
                            }
                        }
                        
                        options.series.push(series_null);
                    }

                    var chart = Highcharts.chart('container', options);
                    
                    $.each(chart.series, function(i, s) {
                        if ($('#Hidden_series').val() == ''){
                            // document.getElementById("table_FLOW").style.display = "none";
                        }else{
                            if (s.name == $('#Hidden_series').val()){
                                s.show();
                            }else{
                                s.hide();
                            }
                        }
                    });


                },
                complete: function(XMLHttpRequest, textStatus) { 
                    $('.close').click();
                    init();


                    var element1;
                    if ($('#Hidden_SLOW').val() == ''){
                        // 沒有button
                        element1 = $('#container span.highcharts-subtitle').html() + '        <button type="button" id="button-test" onclick="slow_KSR(\'SLOW\')" >查詢SLOW</button>';
                    }else{
                        // 有button
                        element1 = $('#container span.highcharts-subtitle').html() + '        <button type="button" id="button-test" onclick="slow_KSR(\'\')" >回到KSR</button>';
                    }


                    
                    $('#container span.highcharts-subtitle').html(element1);
                   

                }
            });

            //                 $.get('http://tw100018633/L8B/Report/KSR_Highchart_json.aspx?json=json&time=' + Date.now(), function(data) {
            //                     //console.log(data);
            //                     //console.log('requestData_START：' + Date.now());

            //                     var lines = data.split('\n');

            //                     var stage_id = ''

                
                
            //                     var series_model = [];
            //                     var str_model = ''
                

            //                     $.each(lines, function(lineNo, line) {
            //                         var items = line.split(',');
            //                         // 第一行的時候就先把SERIES_MODEL建起來


            //                         if (items[0].indexOf(':') >= 0) {
            //                             //update_time
            //                             //stage_id
            //                             //stage_seq

            //                             //lineNo	5

            //                             //sampling
            //                             //mor
            //                             //rw
            //                             //target_move
            //                             //D1
            //                             //D2
            //                             //N1
            //                             //N2

            //                             if (items[0].indexOf('stage_id') >= 0) {
            //                                 //options.xAxis.categories.push(item);


            //                                 // stage_id = items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)
            //                                 // options.xAxis[0].categories.push(stage_id);


            //                                 // if (stage_id !== '') {
            //                                 //     var null_data = {
            //                                 //         name: stage_id,
            //                                 //         y:0,
            //                                 //         drilldown: stage_id + '##',
            //                                 //     };
            //                                 //     series_null.data.push(null_data);
            //                                 // }

            //                             } else if (items[0].indexOf('sampling') >= 0) {
            //                                 if (stage_id !== '') {
                            
            //                                     var sampling_data = {
            //                                         name: stage_id,
            //                                         y: Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)),
            //                                         drilldown: stage_id + '#sampling#SAMPLING',
            //                                     };

            //                                     series_sampling.data.push(sampling_data);


            //                                     //series_sampling.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('mor') >= 0) {
            //                                 if (stage_id !== '') {

            //                                     var mor_data = {
            //                                         name: stage_id,
            //                                         y: Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)),                                        
            //                                         drilldown: stage_id + '#mor#MOR',
            //                                     };

            //                                     series_mor.data.push(mor_data);


            //                                     //series_mor.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('rw') >= 0) {
            //                                 if (stage_id !== '') {
                                
            //                                     // 因為RW是最先放進去的seriel，所以Xaxis的drilldown會跟著RW的
            //                                     var tempY = Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1));                                    


            //                                     var rw_data = {
            //                                         name: stage_id,
            //                                         y: Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)),
            //                                         drilldown: stage_id + '#rw#RW',
            //                                     };

            //                                     series_rw.data.push(rw_data);


            //                                     //series_rw.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('target_move') >= 0) {
            //                                 if (stage_id !== '') {
            //                                     series_TARGET.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('D1') >= 0 && items[0].indexOf('D1') < 10) {
            //                                 if (stage_id !== '') {
            //                                     // series_D1.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
                                
            //                                     var D1_data = {
            //                                         name: stage_id,
            //                                         y: Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)),
            //                                         drilldown: stage_id + '#D1#MOVE',
            //                                     };

            //                                     series_D1.data.push(D1_data);                                    

            //                                 }
            //                             } else if (items[0].indexOf('D2') >= 0 && items[0].indexOf('D2') < 10) {
            //                                 if (stage_id !== '') {
            //                                     series_D2.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('N1') >= 0 && items[0].indexOf('N1') < 10) {
            //                                 if (stage_id !== '') {
            //                                     series_N1.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('N2') >= 0 && items[0].indexOf('N2') < 10) {
            //                                 if (stage_id !== '') {
            //                                     series_N2.data.push(Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1)));
            //                                 }
            //                             } else if (items[0].indexOf('update_time') >= 0 ) {
            //                                 options.title.text = '《L8B ARRAY KSR》更新時間：' + items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 4);
            //                             } else if (items[0].indexOf('stage_seq') < 0) {
            //                                 if (stage_id !== '') {
                            
            //                                     var model = ''
            //                                     if (items[0].trim().substr(1, 8).trim().length == 8){
            //                                         model = items[0].trim().substr(1, 8).trim();
            //                                     }else{
            //                                         model = items[0].trim().substr(2, 8).trim();
            //                                     }
            //                                     if (str_model.indexOf(model) < 0 && model.substr(5,1) == '_') {

            //                                         var color = '';


            // //                                        do {
            // //                                            setTimeout(100);
            // //                                        } while (map_color.size == 0);


            //                                         //console.log(model + '_' + map_color.get(model));
            //                                         if (map_color.get(model) !== undefined){
            //                                             if (map_color.get(model) !== '未設定'){
            //                                                 color = '#' + map_color.get(model);
            //                                             }
            //                                         }


            //                                         var series_temp = {
            //                                             name: model,
            //                                             yAxis: 0,
            //                                             // pointWidth: 13,
            //                                             type: 'column',
            //                                             marker: {
            //                                                 enabled: false
            //                                             },
            //                                             data: [],
            //                                             drilldown: [],
            //                                             color: color,
            //                                         };
                            
            //                                         series_model.push(series_temp);
            //                                         str_model += ',' + model;

            //                                     }

            //                                 }
            //                             }
            //                         }                    

            //                     });
                
                
            //                     options.series.splice(0, options.series.length);


            //                     for (i = 0; i < series_model.length; i++) {
            //                         $.each(lines, function(lineNo, line) {

            //                             var items = line.split(',');

            //                             if (items[0].indexOf(series_model[i].name) >= 0) {
                            
            //                                 var stage_name = options.xAxis[0].categories[series_model[i].data.length];
            //                                 var wip_qty = Number(items[0].substr(items[0].indexOf(':') + 3, items[0].length - items[0].indexOf(':') - 3 - 1));
            //                                 var color = '';

            //                                 if (map_color.get(series_model[i].name) !== undefined){
            //                                     if (map_color.get(series_model[i].name) !== '未設定'){
            //                                         color = '#' + map_color.get(series_model[i].name);
            //                                     }
            //                                 }


            //                                 var temp_data = {
            //                                     name: stage_name,
            //                                     y: wip_qty,
            //                                     drilldown: stage_name + '#' + series_model[i].name + '#WIP',
            //                                     color: color,
            //                                 };

            //                                 series_model[i].data.push(temp_data);
            //                                 //series_model[i].color : color;

            // //                                series_model[i].data.push(wip_qty);

            // //                                if (wip_qty >= 0) {                                    
            // //                                    series_model[i].drilldown.push(options.xAxis[0].categories[series_model[i].data - 1] + '#' + series_model[i].name + '#WIP');
            // //                                } else if (wip_qty < 0) {
            // //                                    series_model[i].drilldown.push(options.xAxis[0].categories[series_model[i].data - 1] + '#' + series_model[i].name + '#');
            // //                                }

            //                             } 
            //                         });
            //                         options.series.push(series_model[i]);
            //                     }


            //                     // options.series.push(series_sampling);
            //                     // options.series.push(series_mor);
            //                     // options.series.push(series_rw);
            //                     // options.series.push(series_TARGET);
            //                     // options.series.push(series_D1);
            //                     // options.series.push(series_D2);
            //                     // options.series.push(series_N1);
            //                     // options.series.push(series_N2);

            //                     // options.series.push(series_null);

            //                     // 创建图表
            //                     // var chart = Highcharts.chart('container', options);                    

                
            //                     // var labels = document.querySelectorAll('.highcharts-xaxis-labels')[0].childNodes;
            //                     // labels.forEach(stage => {
            //                     //     stage.addEventListener('click', StageClick(stage.innerHTML));
            //                     // })
                
            //                 });

            //                 //console.log('requestData_END：' + Date.now());



            DIVhold();
            // console.log(new Date());            

        }

        function DIVhold(){
            $('#DIV_Hold iframe').remove();
            $('#DIV_Hold').append('<iframe id="Iframe_hold" runat="server" frameborder="0" marginheight="0" marginwidth="0" src="http://tw100018633/L8B/Report/HOLD/futurehold.aspx" style="border: 0px; width: 600px; min-height: 600px;" ></iframe>');

            setiFrameHeigth();
        }

        var options_wipTable = {
            "ajax":{},
            "paging": false,
            "orderCellsTop": true,
            "fixedHeader": true,
            "dom": 'Brtp',    //<"toolbar">C<"clear">lBrtip
            "ordering": false,
            "oLanguage": {
                "sSearch": "關鍵字查詢:",
                "sProcessing": "正在讀取資料...",
                "sLengthMenu": "顯示 _MENU_ 筆資訊"
            },
            "processing": true, //顯示資料處理狀態
            "destroy": true,
            "retrieve": true,
            "colVis": {
                "buttonText": "隱藏/顯示欄位"

            },
            "autoWidth": false,
            "columns": [
                { data: 'PROD' },
                { data: 'MODEL',
                    render: function (data, type, row, meta) {
                        // $('#Search_Model').val(data.split('_')[0]);
                        if(data == null){
                            return data;
                        }else{
                            return '<label onclick="modelGroupModal(\'' + data.split('_')[0] + '\')" style="color: #007bff;">' + data.split('_')[0] + '</label>';
                        }
                        
                    }
                },
                { data: 'ABBR_NO'},
                { 
                    data: 'LOT_ID',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    },
                    render: function (data, type, row, meta) { 
                        return '<a href="Lot_History_L8B.aspx?lot_id=' + data + '" target="_blank">' + data + '</a>';
                    }
                },
                { 
                    data: 'CST',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    }  
                },
                { 
                    data: 'SHEET_QTY',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    } 
                },
                { 
                    data: 'LOT_STATUS',
                    // HLDL的話點下去用modal顯示所有HOLD
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    }  
                },                                                                            
                { 
                    data: 'PEPS',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    }  
                },
                { 
                    data: 'STAGE_ID',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    },
                    render: function (data, type, row, meta) {
                        if (data == null){
                            return data;
                        }else{
                            return '<label onclick="stageGroupModal(\'' + data.split('_')[0] + '\')" style="color: #007bff;">' + data.split('_')[0] + '</label>';
                        }
                        
                    }

                    // stageGroupModal
                },
                { 
                    data: 'PEP_LEVEL',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_1(rowData, td);
                    }  
                },
                { 
                    data: 'ROUTE_ID',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_2(rowData, td);
                    },
                    render: function (data, type, row, meta) {
                        // 檢查是否單機
                        if (data != null){
                            if (parseInt(data.split('_')[1]) <= 1){                                                    
                                return '<a href="Route_Info.aspx?ROUTE_ID=' + data.split('_')[0] + '&opid=' + encodeURIComponent(row["OP_ID"]) + ' " target="_blank" title="' + row["CHECKBOX"] + '" style="color: #ff0000">' + data.split('_')[0] + '</a>';
                            }else{
                                return '<a href="Route_Info.aspx?ROUTE_ID=' + data.split('_')[0] + '&opid=' + encodeURIComponent(row["OP_ID"]) + ' " target="_blank" title="' + row["CHECKBOX"] + '">' + data.split('_')[0] + '</a>';
                            }
                        }else{
                            return '';
                        }
                    }
                },
                { 
                    data: 'OP_ID',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_2(rowData, td);


                        if (rowData["CONSTRAINT"] != null){
                            var tooltip_str = '';
                            tooltip_str = '<table border="1" class="tooltip_table">';
                            tooltip_str += '<tr>';

                            if (rowData["CONSTRAINT"] != '-'){
                                $(td).addClass('wip_qtime');
                                // $(td).attr('title', rowData["CONSTRAINT"]);
                                tooltip_str += '<th>CONSTRAINT</th>';
                            }

                            if (rowData["HOLDSAMPLING"] != '-'){
                                $(td).addClass('wip_qtime');
                                // $(td).attr('title', rowData["HOLDSAMPLING"]);
                                tooltip_str += '<th>' + rowData["HOLDSAMPLING"].split("(")[0] + '</th>';  
                            }
        
                            tooltip_str += '</tr>';
                            tooltip_str += '<tr>';
                            if (rowData["CONSTRAINT"] != '-'){
                                tooltip_str += '<td>' + rowData["CONSTRAINT"] + '</td>';
                            }
                            if (rowData["HOLDSAMPLING"] != '-'){
                                tooltip_str += '<td>' + rowData["HOLDSAMPLING"].split("(")[1].replace(")", "") + '</td>';
                            }
                            tooltip_str += '</tr>';
                            tooltip_str += '</table>';

                            
                            if (rowData["CONSTRAINT"] != '-' | rowData["HOLDSAMPLING"] != '-'){
                                $(td).attr('onmouseover','display_popup(event, "' + tooltip_str + '")')
                                $(td).attr('onmouseout','display_popup(event, "")')
                            }




                            if (rowData["EQP_MFG_SAMPLING"] != '-'){

                                tooltip_str = '<table border="1" class="tooltip_table">'
                                tooltip_str += '<tr><td>' + rowData["EQP_MFG_SAMPLING"] + '</td></tr></table>';
                                $(td).addClass('EQP_MFG_SAMPLING'); 
                                $(td).attr('onmouseover','display_popup(event, "' + tooltip_str + '")')
                                $(td).attr('onmouseout','display_popup(event, "")')
                            }    
                        }
                        
                    },
                    
                },
                { 
                    data: 'LOT_PRIORITY',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_2(rowData, td);
                    }  
                },
                { 
                    data: 'HOLD_HOUR',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_2(rowData, td);
                    }
                },
                { 
                    data: 'QTIME',
                    createdCell: function (td, cellData, rowData, row, col) {
                        table_drawColor_2(rowData, td);

                        if (parseInt(cellData) < 0){
                            $(td).addClass('wip_qtime');
                        }
                    }  
                },                                        
                { 
                    data: 'CHECKBOX',
                    createdCell: function (td, cellData, rowData, row, col) {
                        
                        if (rowData["ROUTE_ID"] != null){
                            if (rowData["ROUTE_ID"].substr(0,1) == 'S'){
                                if (rowData["CHECKBOX"] == 'EQP_SAMPLING' | rowData["CHECKBOX"] == 'LTSM'){
                                    $(td).addClass('wip_sampling');
                                }
                            }
                        }
                    },
                    render: function (data, type, row, meta) { 

                        if (row["ROUTE_ID"] != null){
                            if (row["ROUTE_ID"].substr(0,1) == 'S'){
                                // if (data == 'EQP_SAMPLING' | data == 'LTSM'){
                                    
                                // }else{
                                //     // 不可過SAMPLING
                                    
                                // }
                                
                                return '<input type="checkbox" class="wip_cb" onclick="CBclick(this)" id="LOT_' + row["LOT_ID"] + '-CST_' + row["CST"] + '" name="' + data + '" title="' + data + '" >';

                            }else{
                                return '<input type="checkbox" class="wip_cb" onclick="CBclick(this)" id="LOT_' + row["LOT_ID"] + '-CST_' + row["CST"] + '" name="" >';
                            }
                        }else{
                            return data;
                        }
                        


                        // INPR都不給勾
                        // if (data != null){
                        //     if (row["LOT_STATUS"].indexOf('INPR') >= 0){
                        //         return '<input type="checkbox" class="wip_cb" onclick="CBclick(this)" disabled title="' + data + '" name="' + data + '" id="LOT_' + row["LOT_ID"] + '-CST_' + row["CST"] + '">';
                                
                        //     }else{
                        //         return '<input type="checkbox" class="wip_cb" onclick="CBclick(this)" title="' + data + '" name="' + data + '" id="LOT_' + row["LOT_ID"] + '-CST_' + row["CST"] + '">';
                        //     }
                        // }else{
                        //     return '<input type="checkbox" class="wip_cb" onclick="CBclick(this)" title="' + data + '" name="' + data + '" id="LOT_' + row["LOT_ID"] + '-CST_' + row["CST"] + '">';
                        // }
                        
                    }
                },
                { data: 'AJAX_TIME' },
            ],
            "order": [[ 14, 'desc' ], [ 13, 'asc' ], [ 0, 'asc' ], [ 1, 'asc' ]],
            "columnDefs":[
                // row.LOT_STATUS
                // meta.col
                {
                    targets: '_all',
                    className: 'text-center text-nowrap'
                },

            ],
                                
        }

        // var options_groupTable = {
        //     "ajax":{},
        //     "paging": false,
        //     "orderCellsTop": true,
        //     "fixedHeader": true,
        //     "dom": 'Brtp',    //<"toolbar">C<"clear">lBrtip
        //     "ordering": false,
        //     "oLanguage": {
        //         "sSearch": "關鍵字查詢:",
        //         "sProcessing": "正在讀取資料...",
        //         "sLengthMenu": "顯示 _MENU_ 筆資訊"
        //     },
        //     "processing": true, //顯示資料處理狀態
        //     "destroy": true,
        //     "retrieve": true,
        //     "colVis": {
        //         "buttonText": "隱藏/顯示欄位"

        //     },
        //     "autoWidth": false,
        //     "columns": [
        //         { data: 'STAGE_ID' },
        //         { data: 'OP_ID'},
        //         { data: 'MODEL_NO' },
        //         { data: 'ABBR_NO' },
        //         { data: 'EQP_GROUP',
        //             // render: function (data, type, row, meta) { 
        //             //     return '<a href="Route_Info.aspx?ROUTE_ID=' + data + '"" target="_blank">' + data + '</a>';
        //             // }
        //         },
        //         { data: 'LOT_CNT'},
        //         { data: 'SHEET_QTY'},
        //         { data: 'EQP_ID',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 } 
        //             },
        //         },
        //         { data: 'ENG_ENABLED_FLAG',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 } 
        //                 if (rowData["ENG_ENABLED_FLAG"] == 'N'){
        //                     $(td).addClass('wip_qtime');
        //                 } 
        //             },
        //         },
        //         { data: 'ENG_LM_USER',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 } 
        //             },
        //         },
        //         { data: 'ENG_LM_TIME',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 } 
        //             },
        //         },
        //         { data: 'MFG_ENABLED_FLAG',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 }
        //                 if (rowData["MFG_ENABLED_FLAG"] == 'N'){
        //                     $(td).addClass('wip_qtime');
        //                 } 
        //             },
        //         },
        //         { data: 'MFG_LM_USER',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 } 
        //             },
        //         },
        //         { data: 'MFG_LM_TIME',
        //             createdCell: function (td, cellData, rowData, row, col) {
        //                 if (rowData["IS_ENABLED"] == 'N'){
        //                     $(td).addClass('GROUP_CLOSE');
        //                 } 
        //             },
        //         },
        //     ],
        //     "order": [[ 0, 'desc' ], [ 1, 'asc' ], [ 2, 'asc' ], [ 3, 'asc' ]],
        //     "columnDefs":[
        //         // row.LOT_STATUS
        //         // meta.col
        //         {
        //             targets: '_all',
        //             className: 'text-center text-nowrap'
        //         },

        //     ],

        // }

        
        var options = {
            chart: {
                animation: true,                    
                // backgroundColor: '#FFFFFF',
                // shadow: true,    
                type: 'column',
                // backgroundColor: {
                //     linearGradient: [0, 0, 500, 500],
                //     stops: [
                //         [0, 'rgb(230, 230, 230)'],
                //         [1, 'rgb(245, 245, 245)']
                //     ]
                // },
                events: {
                    drilldown: function(e) {
                    
                        const keywords = e.point.drilldown.split('#');
                        Search_Stage.val(keywords[0]);
                        Search_Model.val(keywords[1]);
                        Search_WIP.val(keywords[2]);

                        
                        ShowProgressBar();
                                

                        document.getElementById("table_MOVE").style.display = "none";
                        document.getElementById("table_WIP").style.display = "none";
                        document.getElementById("table_GROUP").style.display = "none";
                        document.getElementById("table_FLOW").style.display = "none";
                        

                        if ($('#Search_WIP').val() == 'MOVE'){
                            table_name = 'table_MOVE'
                            datatables = $('#' + table_name).DataTable({
            
                                "ajax": {
                                    type: "POST",

                                    data: function(d) {
                                        $('#Hidden_rowSpan_CNT').val(0);
                                        var now_date = new Date(new Date() - 450*60*1000);
                                        var now_y = now_date.getUTCFullYear();
                                        var now_m = parseInt(now_date.getMonth()) + 1;
                                        var now_d = now_date.getDate();

                                        return $.extend({}, d, {
                                            "stage" : $('#Search_Stage').val(),
                                            "model" : now_y + '-' + now_m + '-' + now_d + '_' + $('#Search_Model').val(),
                                            "wip" : $('#Search_WIP').val()
                                        });
                                    },
                                    
                                    url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_MOVE&time=" + Date.now() +
                                        "&data=data",
                                    complete: function(){
                                        // setTimeout(function(){
                                        //     HideProgressBar();
                                        // }, 1400);
                                    }
                                },

                                "paging": false,
                                "orderCellsTop": true,
                                "fixedHeader": true,
                                "dom": 'Brtp',    //<"toolbar">C<"clear">lBrtip
                                "ordering": false,
                                "oLanguage": {
                                    "sSearch": "關鍵字查詢:",
                                    "sProcessing": "正在讀取資料...",
                                    "sLengthMenu": "顯示 _MENU_ 筆資訊"
                                },
                                "processing": true, //顯示資料處理狀態
                                "destroy": true,
                                "retrieve": true,
                                "colVis": {
                                    "buttonText": "隱藏/顯示欄位"

                                },
                                "autoWidth": false,
                                "columns": [
                                    { data: 'PROD' },
                                    { data: 'MODEL' },
                                    { data: 'ABBR_NO'},
                                    { data: 'LOT_ID' },
                                    { data: 'CST' },
                                    { data: 'EQP_ID' },      
                                    { data: 'STAGE_ID' },      
                                    { data: 'OP_ID' },      
                                    { data: 'LOGOFF_SHEET_QTY'},
                                    { data: 'PROCESS_SHEET_QTY'},                                                                      
                                    { data: 'LOGON_TIME' },
                                    { data: 'EQP_RUN_ID_START_TIME' },
                                    { data: 'LOGOFF_TIME' },                                        
                                ],
                                "columnDefs":[
                                    // row.LOT_STATUS
                                    // meta.col
                                    {
                                        targets: '_all',
                                        className: 'text-center text-nowrap'
                                    },
                                    {
                                        targets: 3,
                                        render: function (data) {
                                            return '<a href="Lot_History_L8B.aspx?lot_id=' + data + '" target="_blank">' + data + '</a>';
                                        },
                                    },                                       
                                    
                                    
                                ],


                            });
                            $('#Hidden_DrillData').val(0);
                        }else{
                            table_name = 'table_WIP'
                            
                            var temp_ajax = {
                                type: "POST",
                                // cache: false,
                                // async: false,
                                data: function(d) {
                                    $('#Hidden_rowSpan_CNT').val(0);

                                    return $.extend({}, d, {
                                        "stage" : $('#Search_Stage').val(),
                                        "model" : $('#Search_Model').val(),
                                        "wip" : $('#Search_WIP').val()
                                    });
                                },
                                
                                url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_WIP&time=" + Date.now() + 
                                    "&stage=" + 
                                    "&model=" + 
                                    "&wip=" + 
                                    "&data=data" +
                                    "&slow=" + $('#Hidden_SLOW').val(),

                                error: function (jqXHR, exception) {

                                    var msg = '';
                                    if (jqXHR.status === 0) {
                                        msg = 'Not connect.\n Verify Network.';
                                    } else if (jqXHR.status == 404) {
                                        msg = 'Requested page not found. [404]';
                                    } else if (jqXHR.status == 500) {
                                        msg = 'Internal Server Error [500].';
                                    } else if (exception === 'parsererror') {
                                        msg = 'Requested JSON parse failed.';
                                    } else if (exception === 'timeout') {
                                        msg = 'Time out error.';
                                    } else if (exception === 'abort') {
                                        msg = 'Ajax request aborted.';
                                    } else {
                                        msg = 'Uncaught Error.\n' + jqXHR.responseText;
                                    }
                                    
                                    console.log('ajax error：' + msg);
                                },
                                complete: function () {
                                    console.log('complete');
                                }

                            };
                            options_wipTable.ajax = temp_ajax;                                
                            datatables = $('#' + table_name).DataTable(options_wipTable);
                            

                            // 2022-07-12
                            // 在點STAGE_ID的時候去查GROUP                                
                            // var group_ajax = {
                            //     type: "POST",

                            //     data: function(d) {
                            //         $('#Hidden_rowSpan_CNT').val(0);

                            //         return $.extend({}, d, {
                            //             "stage" : $('#Search_Stage').val()
                            //         });
                            //     },
                                
                            //     url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=STAGE_MODEL_GROUP&time=" + Date.now() + 
                            //         "&stage=" + 
                            //         "&model=" + 
                            //         "&wip=" + 
                            //         "&data=data",

                            //     // success: function (data) {
                            //     //     console.log('ajax success');
                            //     // },
                            //     error: function (jqXHR, exception) {

                            //         var msg = '';
                            //         if (jqXHR.status === 0) {
                            //             msg = 'Not connect.\n Verify Network.';
                            //         } else if (jqXHR.status == 404) {
                            //             msg = 'Requested page not found. [404]';
                            //         } else if (jqXHR.status == 500) {
                            //             msg = 'Internal Server Error [500].';
                            //         } else if (exception === 'parsererror') {
                            //             msg = 'Requested JSON parse failed.';
                            //         } else if (exception === 'timeout') {
                            //             msg = 'Time out error.';
                            //         } else if (exception === 'abort') {
                            //             msg = 'Ajax request aborted.';
                            //         } else {
                            //             msg = 'Uncaught Error.\n' + jqXHR.responseText;
                            //         }
                                    
                            //         console.log('ajax error：' + msg);
                            //     }

                            // }
                            // options_groupTable.ajax = group_ajax;
                            // var group_datatables = $('#table_GROUP').DataTable(options_groupTable);
                            // document.getElementById('table_GROUP').style.display = "block";
                            // group_datatables.ajax.reload(function(json){

                            //     console.log('group_ajax');

                            //     setTimeout(function(){
                            //         setRowSpan('table_GROUP');
                            //         $('#Hidden_DrillData').val(0);
                            //     }, 7);
                            // });

                        }
                        
                        
                        document.getElementById(table_name).style.display = "block";

                        // console.log('#2386：' + '7');
                        setTimeout(function(){

                            if (parseInt($('#Hidden_rowSpan_CNT').val()) == 0){
                                datatables.ajax.reload(function(json){

                                    // console.log('#2392：' + '7');

                                    setTimeout(function(){
                                        setRowSpan(table_name);
                                        $('#Hidden_DrillData').val(0);
                                    }, 7);
                                });
                            }
                            
                        }, 7);

                    

                        //HideProgressBar();
                    },
                    // drillup: function(e) {
                    // },
                    // load: function(e) {
                    //     requestData(); // 图表加载完毕后执行的回调函数
                    // }
                }
            },
            title: {
                useHTML: true,
                className: 'style1',
                text: '《L8B ARRAY KSR 2.0》更新時間：2021-10-20 14:27',
                y : 20,
                
            },
            subtitle: {
                useHTML: true,                
                text: '.',
                style: {
                    color: '#ffffff',                    
                }
            },

            tooltip: {
                shared: true,
                useHTML: true,
                borderWidth: 0,
                backgroundColor: "rgba(255,255,255,0.93)",
                borderRadius: 0,
                distance: 21,

                // headerFormat: '<table><tr><th colspan="2">{series.name}</th></tr>',                    
                // pointFormatter: function(){                        
                //     if (this.y != 0 & this.options.drilldown != undefined){                            
                //         if (this.options.drilldown.indexOf('#MOVE') < 0){                                 
                //             return '<tr><td><span style="color:' + this.color + '">●</span>' + this.options.drilldown.split('#')[1] + '：</td><td style="text-align: right; font-weight: bold;">' + this.y + '</td></tr>'
                //         }else{
                //             return '<tr><td><span style="color:' + this.color + '">─</span>' + this.options.drilldown.split('#')[1] + '：</td><td style="text-align: right; font-weight: bold;">' + this.y + '</td></tr>'
                //         }
                //     }
                // },
                // footerFormat: '</table>',

                formatter: function () {
                    var total_wip = 0;
                    var stage_id = '';

                    for (let i = 0; i < this.points.length; i++) {
                        if (this.points[i].series.name != 'TARGET' & this.points[i].series.name != 'D1' & this.points[i].series.name != 'D2' & this.points[i].series.name != 'N1' & this.points[i].series.name != 'N2'){
                            if (parseInt(this.points[i].y) > 0){
                                total_wip += parseInt(this.points[i].y);
                            }else{
                                total_wip -= parseInt(this.points[i].y);
                            }
                        }
                        
                    }
                    
                    return this.points.reduce(function (s, point) {
                        stage_id = point.x;
                        if (point.y != 0){
                            if (point.series.name == 'TARGET'){
                                return s + '<tr><td colspan="2"></td></tr>';
                            }else{
                                if (s.indexOf('colspan') == -1 & point.series.name.indexOf('_') == -1){
                                    s = s + '<tr><td colspan="2"></td></tr>';
                                }
                                
                                return s + '<tr>' + 
                                    '<td><span style="color:' + point.series.color + '; text-align: center">●</span>' + point.series.name + '</td>' + 
                                    '<td style="text-align: right;">' + String(point.y).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + '</td>' +
                                     '</tr>';
                            }
                            
                        }else{
                            return s;
                        }
                    }, '<table border="1" class="tooltip_table2"><tr><td style="text-align: center;">MODEL</td><td style="text-align: right;">QTY</td></tr>') + '<span style="fontSize:12pt;">' + stage_id + '：' + String(total_wip).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + '</span><br/><br/>';
                },


            },
            
            credits: {
                text: 'L8B_KSR',
                href: 'http://tw100018633.corpnet.auo.com/L8B/Report/L8B_KSR.aspx'
            },
            exporting: {
                enabled: false
            },
            plotOptions: {
                column: {
                    stacking: 'normal',
                    events: {
                        legendItemClick: function() {
                            
                            var seriesIndex = this.index;
                            var series = this.chart.series;
                            var temp_flag = false;
                            if (this.visible && this.chart.restIsHidden){
                                temp_flag = true;
                                $('#Hidden_series').val('');
                            }else{
                                $('#Hidden_series').val(series[seriesIndex].name);
                            }
                            
                            ShowProgressBar();

                            $.each(this.chart.series, function(i, s){

                                // console.log('#2500：' + '1');
                                setTimeout(function(){
                                    if (i != seriesIndex) {
                                        if (temp_flag){
                                            s.show();
                                        }else{
                                            s.hide();
                                        }
                                    }
                                }, 1);

                            });


                            if (this.visible && this.chart.restIsHidden) {
                                
                                this.chart.restIsHidden = false;
                                document.getElementById("table_WIP").style.display = "none";
                                document.getElementById("table_FLOW").style.display = "none";
                                HideProgressBar();
                                                                    
                            } else {
                                
                                this.show();
                                this.chart.restIsHidden = true;


                                ///////
                                
                                
                                Search_Stage.val('');
                                if (this.chart.series[this.index].name == 'sampling' | this.chart.series[this.index].name == 'mor' | this.chart.series[this.index].name == 'rw'){
                                    Search_Model.val('');
                                    Search_WIP.val(this.chart.series[this.index].name);
                                }else {
                                    // 先不管點到TARGET或MOVE
                                    Search_Model.val(this.chart.series[this.index].name);
                                    Search_WIP.val('WIP');
                                }
                                
                            
                                document.getElementById("table_WIP").style.display = "none";

                                
                                table_name = 'table_WIP'
                                var temp_ajax = {
                                    type: "POST",

                                    data: function(d) {
                                        $('#Hidden_rowSpan_CNT').val(0);

                                        return $.extend({}, d, {
                                            "stage" : $('#Search_Stage').val(),
                                            "model" : $('#Search_Model').val(),
                                            "wip" : $('#Search_WIP').val()
                                        });
                                    },
                                    
                                    url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_WIP&time=" + Date.now() + 
                                        "&stage=" + 
                                        "&model=" + 
                                        "&wip=" + 
                                        "&data=data" +
                                        "&slow=" + $('#Hidden_SLOW').val(),

                                    error: function (error) {
                                        console.log('ajax error：' + error);
                                    },
                                    complete: function () {
                                        // setTimeout(function(){
                                        //     setRowSpan(table_name, true);
                                        // }, 7000);
                                    }
                                }
                                options_wipTable.ajax = temp_ajax                                
                                datatables = $('#' + table_name).DataTable(options_wipTable);
                                
                                document.getElementById(table_name).style.display = "block";



                                

                                //////////////////////////////////////////

                                // console.log('#2577：' + '7');
                                setTimeout(function(){
                                                                            
                                    datatables.ajax.reload(function(json){
                                        $('#Hidden_rowSpan_CNT').val(0);

                                        // console.log('#2583：' + '7');
                                        setTimeout(function(){
                                            setRowSpan(table_name);
                                        }, 77);
                                    });

                                }, 7);
                        
                                ///////
                            }
                            // HideProgressBar();
                            return false;
                        }
                    },
                    showInLegend: true
                },
                series: {
                    pointWidth: 13,
                    borderWidth: 1,
                    // borderWidth: 0,
                    borderColor: "#ddd",
                    // borderRadius: 4,
                }
            },
            yAxis: [{
                className: 'style1',
                labels: {
                    formatter: function() {
                        var label = this.axis.defaultLabelFormatter.call(this);
                        if (/^[0-9]{4}$/.test(label)) {
                            return Highcharts.numberFormat(this.value, 0);
                        }
                        return Highcharts.numberFormat(this.value, 0);
                    },
                    style: {
                        color: Highcharts.getOptions().colors[1],
                    }
                },
                title: {
                    className: 'style1',
                    text: 'SHEET_QTY',
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    }
                },
                gridLineWidth: 2,
                gridLineColor: 'rgba(0, 0, 0, 0.1)',
                // min: $('#Hidden_minY').val(),
                // max: $('#Hidden_maxY').val(),
                // scrollbar: {
                //     enabled: true
                // },
            },
            {
                opposite: true,
                labels: {
                    formatter: function() {
                        var label = this.axis.defaultLabelFormatter.call(this);
                        if (/^[0-9]{4}$/.test(label)) {
                            return Highcharts.numberFormat(this.value, 0);
                        }
                        return Highcharts.numberFormat(this.value, 0);
                    },
                    style: {
                        //color: Highcharts.getOptions().colors[1],
                        color: 'rgba(0, 0, 0, 0)',
                    }
                },
                title: {
                    text: null,
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    }
                },
                gridLineWidth: 0,
                gridLineColor: 'rgba(0, 0, 0, 0.1)',
                // min: $('#Hidden_minY').val(),
                // max: $('#Hidden_maxY').val(),
            }],                
            xAxis: {                    
                categories: [],
                className: 'style1',
                labels: {
                    rotation: 90,                        
                    style: {
                        fontSize: '13'
                    }
                },
                plotBands: [{
                    color: color_5pep,
                    from: min_5pep,
                    to: max_5pep,
                    label: {
                        text: '5PEP',
                        align: 'center',
                        y: 30,
                        style: {
                            color: 'gray',
                            fontWeight: 'bold'
                        }
                    },
                    zIndex: 1,
                }, {
                    color: color_4pep,
                    from: min_4pep,
                    to: max_4pep,
                    label: {
                        text: '4PEP',
                        align: 'center',
                        y: 30,
                        style: {
                            color: 'gray',
                            fontWeight: 'bold'
                        }
                    },
                    zIndex: 1,
                }, {
                    color: color_ahva,
                    from: min_ahva,
                    to: max_ahva,
                    label: {
                        text: 'AHVA',
                        align: 'center',
                        y: 30,
                        style: {
                            color: 'gray',
                            fontWeight: 'bold'
                        }
                    },
                    zIndex: 1,
                }, {
                    color: color_coa,
                    from: min_coa,
                    to: max_coa,
                    label: {
                        text: 'COA',
                        align: 'center',
                        y: 30,
                        style: {
                            color: 'gray',
                            fontWeight: 'bold'
                        }
                    },
                    zIndex: 1,
                }, {
                    color: color_poa,
                    from: min_poa,
                    to: max_poa,
                    label: {
                        text: 'POA',
                        align: 'center',
                        y: 30,
                        style: {
                            color: 'gray',
                            fontWeight: 'bold'
                        }
                    },
                    zIndex: 1,
                }, {
                    color: color_1,
                    from: -0.5,
                    to: 6.5,
                    label: {
                        text: 'PEP1',
                        align: 'left',
                    },
                    zIndex: 0,
                }, {
                    color: color_2,
                    from: 6.5,
                    to: 10.5,
                    label: {
                        text: 'PEP2',
                        align: 'left',
                    },
                    zIndex: 0,
                }, {
                    color: color_3,
                    from: 10.5,
                    to: 19.5,
                    label: {
                        text: 'PEP3',
                        align: 'left',
                    },
                    zIndex: 0,
                }, {
                    color: color_4,
                    from: 19.5,
                    to: 32.5 + AHVA_CNT,
                    label: {
                        text: 'PEP4',
                        align: 'left',
                    },
                    zIndex: 0,
                }, {
                    color: color_5,
                    from: 32.5 + AHVA_CNT,
                    to: 43.5 + AHVA_CNT,
                    label: {
                        text: 'PEP5',
                        align: 'left',
                    },
                    zIndex: 0,
                }],
                type: 'category',
                tickInterval: 1,
                minorTickInterval: 1,
                
                tickWidth: 1,
                tickLength: 20,

                gridLineWidth: 1,
                gridLineColor: 'rgba(128, 128, 128, 0.1)',
            },
            series: [],
            
        };

        

        function requesCOLOR(){
            $.ajax({ 
                type:"get",  
                url:"http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_COLOR",
                dataType:'json', 
                success:function(data){
                    if(data){
                        $.each(data, function(num, data) {
                            map_color.set(data["series_id"], data["color"]);
                        });
                        
                    }
                }
            }); 
        }
        
        function requesMaxMin(){
            $.ajax({ 
                type:"get",  
                url:"http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_MaxMin",
                dataType:'json', 
                success:function(data){
                    if(data){

                        if (data[0]['maxY'] - 500 > data[0]['maxY_NoSHOU']){
                            $('#Hidden_maxY').val(data[0]['maxY_NoSHOU']);
                            // $('#Hidden_maxY').val(data[0]['maxY']);
                        }else{
                            $('#Hidden_maxY').val(data[0]['maxY']);
                        }
                        
                        $('#Hidden_minY').val(data[0]['minY']);

                        options.yAxis[0].max = Math.ceil( $('#Hidden_maxY').val() / 500) * 500; 
                        options.yAxis[0].min = Math.floor( $('#Hidden_minY').val() / 500) * 500;

                        options.yAxis[1].max = Math.ceil( $('#Hidden_maxY').val() / 500) * 500; 
                        options.yAxis[1].min = Math.floor( $('#Hidden_minY').val() / 500) * 500;
                    }
                }
            }); 
        }

        // function requestWIP(ajaxtime){
        //     // $('#table_WIP').DataTable().clear().draw();
        //     console.log('ajaxtime：' + ajaxtime);
        //     $.ajax({
        //         type: "post",
        //         url: "http://tw100018633/json/Json.ashx?json=KSR_WIP&time=" + ajaxtime,
        //         dataType: 'json',
        //         success: function (data) {

        //             if (data) {

        //                 var table = $('#table_WIP').DataTable({
        //                     "data": data,
        //                     "paging": false,
        //                     "orderCellsTop": true,
        //                     "fixedHeader": true,
        //                     "dom": 'Brtp',    //<"toolbar">C<"clear">lBrtip                                
        //                     "ordering": false,
        //                     "oLanguage": {
        //                         "sSearch": "關鍵字查詢:",
        //                         "sProcessing": "正在讀取資料...",
        //                         "sLengthMenu": "顯示 _MENU_ 筆資訊"
        //                     },
        //                     "processing": true, //顯示資料處理狀態
        //                     "destroy": true,
        //                     "retrieve": true,
        //                     "colVis": {
        //                         "buttonText": "隱藏/顯示欄位"
            
        //                     },
        //                     "autoWidth": false,
        //                     "columns": [
        //                         { data: 'PROD' },
        //                         { data: 'MODEL' },
        //                         { data: 'ABBR_NO'},
        //                         { data: 'LOT_ID' },
        //                         { data: 'CST' },
        //                         { data: 'SHEET_QTY'},
        //                         { data: 'LOT_STATUS' },
        //                         { data: 'ROUTE_ID' },
        //                         { data: 'PEPS' },                                    
        //                         { data: 'PEP_LEVEL' },
        //                         { data: 'STAGE_ID' },
        //                         { data: 'OP_ID' },
        //                         { data: 'OP_SEQ' },                                    
        //                         { data: 'HOLD_HOUR' },
        //                         { data: 'QTIME' },
        //                         { data: 'AJAX_TIME' },
        //                         { 
        //                             data: 'CHECKBOX',
        //                             render: function (data, type, row, meta) { 
        //                                 return '<button type="button" onclick=OPI("' + row["LOT_ID"] + '")></button>';
        //                             }
        //                          },
        //                     ],
        //                     "order": [[ 14, 'desc' ], [ 13, 'asc' ], [ 0, 'asc' ], [ 1, 'asc' ]],

        //                     ///////
        //                     "columnDefs":[
        //                         // row.LOT_STATUS
        //                         // meta.col
        //                         {
        //                             targets: '_all',
        //                             className: 'text-center text-nowrap'
        //                         },
        //                         {
        //                             orderable: false,
        //                             className: 'select-checkbox',
        //                             targets:   16
        //                         },
        //                         // {
        //                         //     targets: 3,
        //                         //     "render": function (data, type, row, meta) {
        //                         //         return '<a href="Lot_History_L8B.aspx?lot_id=' + data + '"" target="_blank">' + data + '</a>';
        //                         //     }
        //                         // },
        //                         {
        //                             targets: [3,4,5,6,7,8,9,10,11,12],
        //                             "render": function (data, type, row, meta) {
        //                                 if (meta.col == 3){
        //                                      data = '<a href="Lot_History_L8B.aspx?lot_id=' + data + '"" target="_blank">' + data + '</a>';
        //                                 }


        //                                 if (row.LOT_STATUS.indexOf('HLDL') >= 0){
        //                                     // return '<span style="background-color: khaki">' + data + '</span>'
        //                                     return '<div style="background-color: khaki">' + data + '</div>'
        //                                 }else if (row.LOT_STATUS == 'INPR'){                                                
        //                                     return '<div style="background-color: DarkTurquoise">' + data + '</div>'
        //                                 }else{
        //                                     return data
        //                                 }
        //                             }
        //                         },
        //                         {
        //                             targets: [1],
        //                             createdCell: function(cell, cellData, rowData, rowIndex, colIndex){
        //                                 if (rowIndex == 0){

        //                                 }
        //                             }
        //                         },
        //                         {
        //                             targets: 13,
        //                             render: function (data) {
        //                                 if (data != '-'){

        //                                     var hold = new Date(data);
        //                                     var now_time = new Date(Date.now());
        //                                     var difference = now_time.getTime() - hold.getTime();

        //                                     return Math.round(difference / 1000 / 60 / 60 * 100, 1) / 100
        //                                 }else{
        //                                     return data
        //                                 }
                                        
        //                             },
        //                         },
        //                         {
        //                             targets: 14,
        //                             render: function (data) {
        //                                 if (data != '-'){

        //                                     var qt = new Date(data);
        //                                     var now_time = new Date(Date.now());
        //                                     var difference = qt.getTime() - now_time.getTime();
                                            
        //                                     if (difference < 0){
        //                                         return '<span style="color: #ff0000"><strong>' + Math.round(difference / 1000 / 60 / 60 * 100, 1) / 100 + '</strong></span>'
        //                                     }else{
        //                                         return Math.round(difference / 1000 / 60 / 60 * 100, 1) / 100
        //                                     }
        //                                 }else{
        //                                     return data
        //                                 }
                                        
        //                             },
        //                         }
        //                     ],
        //                     "select": {
        //                         style:    'os',
        //                         selector: 'td:first-child'
        //                     },

        //                     ///////
        //                 });

                        
        //             }
        //         },
        //         complete:function(XMLHttpRequest, textSuatus){
        //             // $('#table_WIP').DataTable().draw();
        //             // displayNoneALL('table_WIP');
        //             // myFunction('table_WIP');

        //         }
        //     }); 
        // }

        // function GetWIPData(Search_Stage, Search_Model, Search_WIP) {
        //     var jdata;
        //     $.ajax({
        //         type: "GET",
        //         cache: false,
        //         async: false,
        //         url: "http://tw100018633/json/Json.ashx?json=KSR_WIP&time=" + Date.now() + "&stage=" + Search_Stage + "&model=" + Search_Model + "&wip=" + Search_WIP,
        //     }).done(function (result) {
        //         jdata = result;
        //         return jdata;
        //     }).fail(function (xhr, result, status) {
        //         alert('GetWIPData ' + xhr.statusText + ' ' + xhr.responseText + ' ' + xhr.status);
        //     });
        //     return jdata;
        // }
        
        function table_drawColor_1(rowData, td){
            if (rowData["LOT_STATUS"] != null){
                if (rowData["LOT_STATUS"].indexOf('HLDL') >= 0){
                    $(td).addClass('wip_hold');
                } else if (rowData["LOT_STATUS"].indexOf('INPR') >= 0){
                    $(td).addClass('wip_inpr');
                }
            }                
        }
        
        function table_drawColor_2(rowData, td){
            if (rowData["LOT_STATUS"] != null){
                if (rowData["OP_ID"].indexOf('=') >= 0 ){
                    $(td).addClass('wip_sampling');
                }else if (rowData["OP_ID"].indexOf('+') >= 0 ){
                    $(td).addClass('wip_rw');
                }else if (rowData["LOT_STATUS"].indexOf('HLDL') >= 0){
                    $(td).addClass('wip_hold');
                } else if (rowData["LOT_STATUS"].indexOf('INPR') >= 0){
                    $(td).addClass('wip_inpr');
                }
            }                
        }

        function slow_KSR(slow){

            ShowProgressBar();
            clearInterval(intervalID);

            if (slow == 'SLOW'){
                $('#Hidden_SLOW').val('SLOW');
                options.yAxis[0].max = undefined;
                options.yAxis[0].min = undefined;

                options.yAxis[1].max = undefined;
                options.yAxis[1].min = undefined;


                table_name = 'table_WIP'
                            
                var temp_ajax = {
                    type: "POST",

                    data: function(d) {
                        $('#Hidden_rowSpan_CNT').val(0);

                        return $.extend({}, d, {
                            "stage" : $('#Search_Stage').val(),
                            "model" : $('#Search_Model').val(),
                            "wip" : $('#Search_WIP').val()
                        });
                    },
                    
                    url: "http://tw100018633.corpnet.auo.com/json/Json.ashx?json=KSR_WIP&time=" + Date.now() + 
                        "&stage=" + 
                        "&model=" + 
                        "&wip=" + 
                        "&data=data" +
                        "&slow=" + $('#Hidden_SLOW').val(),

                    // success: function (data) {
                    //     console.log('ajax success');
                    // },
                    error: function (jqXHR, exception) {

                        var msg = '';
                        if (jqXHR.status === 0) {
                            msg = 'Not connect.\n Verify Network.';
                        } else if (jqXHR.status == 404) {
                            msg = 'Requested page not found. [404]';
                        } else if (jqXHR.status == 500) {
                            msg = 'Internal Server Error [500].';
                        } else if (exception === 'parsererror') {
                            msg = 'Requested JSON parse failed.';
                        } else if (exception === 'timeout') {
                            msg = 'Time out error.';
                        } else if (exception === 'abort') {
                            msg = 'Ajax request aborted.';
                        } else {
                            msg = 'Uncaught Error.\n' + jqXHR.responseText;
                        }
                        
                        console.log('ajax error：' + msg);
                    }

                }
                options_wipTable.ajax = temp_ajax;
                datatables = $('#' + table_name).DataTable(options_wipTable);
                document.getElementById("table_WIP").style.display = "block";

                setTimeout(function(){

                    if (parseInt($('#Hidden_rowSpan_CNT').val()) == 0){
                        datatables.ajax.reload(function(json){

                            // console.log('#2392：' + '7');

                            setTimeout(function(){
                                setRowSpan(table_name);
                                $('#Hidden_DrillData').val(0);
                            }, 7);
                        });
                    }

                }, 7);


            }else{
                $('#Hidden_SLOW').val('');
                document.getElementById("table_WIP").style.display = "none";
                requesMaxMin();
            }

            requestData($('#Hidden_SLOW').val());
            intervalID = setInterval(function(){ requestData($('#Hidden_SLOW').val()); }, 5 * 60 * 1000); //600秒,600000
            HideProgressBar();            

        }


        $(document).ready(function() {


            document.getElementById("table_MOVE").style.display = "none";
            document.getElementById("table_WIP").style.display = "none";
            document.getElementById("table_GROUP").style.display = "none";
            document.getElementById("table_FLOW").style.display = "none";
            
            
            // requestData();

            // $('#Hidden_SLOW').val('slow');
            $('#Hidden_SLOW').val('');
            // intervalID = setInterval(requestData($('#Hidden_SLOW').val()), 3 * 60 * 1000); //600秒,600000

            requestData($('#Hidden_SLOW').val());
            intervalID = setInterval(function(){ requestData($('#Hidden_SLOW').val()); }, 5 * 60 * 1000);

            
            // setInterval(DIVhold(), 3 * 60 * 1000); //600秒,600000
            

        });

        
        
    </script>

</body>
</html>
